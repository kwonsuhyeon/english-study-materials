<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∞ùÍ¥ÄÏãù ÏòÅÏñ¥ Îã®Ïñ¥ ÌÄ¥Ï¶à</title>
    <!-- START_USER_EDITABLE_CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            width: 100%;
        }
        
        .title {
            color: #333;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }
        
        .name-input {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .name-input input {
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            width: 100%;
            max-width: 300px;
            margin-bottom: 15px;
        }
        
        .progress-section {
            margin-bottom: 20px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .question-counter {
            font-size: 14px;
            color: #666;
        }
        
        .progress {
            background: #e1e5e9;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .question-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 15px;
            padding: 40px 30px;
            margin: 30px 0;
            color: white;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .question-title {
            font-size: 18px;
            margin-bottom: 20px;
            opacity: 0.9;
        }
        
        .english-word {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .sound-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            color: white;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.3s;
        }
        
        .sound-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .choices-container {
            margin: 30px 0;
        }
        
        .choice {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin: 10px 0;
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .choice:hover {
            border-color: #4facfe;
            background: #f8f9ff;
        }
        
        .choice.selected {
            border-color: #4facfe;
            background: #e6f3ff;
        }
        
        .choice.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .choice.wrong {
            border-color: #f44336;
            background: #ffeaea;
            color: #c62828;
        }
        
        .choice.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .choice-letter {
            font-weight: bold;
            margin-right: 10px;
            color: #666;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 120px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .next-btn {
            background: #4facfe;
            color: white;
            width: 100%;
            margin-top: 20px;
        }
        
        .next-btn:hover:not(:disabled) {
            background: #3b9cfe;
            transform: translateY(-2px);
        }
        
        .start-btn, .retry-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            font-size: 18px;
        }
        
        .start-btn:hover, .retry-btn:hover {
            transform: translateY(-2px);
        }
        
        .results-screen {
            text-align: center;
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            color: #4facfe;
            margin: 20px 0;
        }
        
        .accuracy {
            font-size: 24px;
            color: #666;
            margin-bottom: 30px;
        }
        
        .results-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 30px 0;
            text-align: left;
        }
        
        .result-item {
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            border: 2px solid;
        }
        
        .result-item.correct {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        
        .result-item.wrong {
            border-color: #f44336;
            background: #ffeaea;
        }
        
        .result-word {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .result-answer {
            font-size: 14px;
            color: #666;
        }
        
        .result-correct-answer {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .result-wrong-answer {
            color: #f44336;
        }
        
        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .hidden {
            display: none;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .english-word {
                font-size: 28px;
            }
            
            .choice {
                padding: 12px 15px;
                font-size: 14px;
            }
            
            .buttons-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
    <!-- END_USER_EDITABLE_CSS -->
</head>
<body>
    <!-- START_USER_EDITABLE_HTML -->
    <div class="container">
        <!-- ÏãúÏûë ÌôîÎ©¥ -->
        <div id="startScreen">
            <h1 class="title">Í∞ùÍ¥ÄÏãù ÏòÅÏñ¥ Îã®Ïñ¥ ÌÄ¥Ï¶à</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                5Í∞úÏùò Îã®Ïñ¥ Î¨∏Ï†úÎ•º ÌíÄÏñ¥Î≥¥ÏÑ∏Ïöî!
            </p>
            <div class="name-input">
                <input type="text" id="learnerName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" maxlength="20">
                <br>
                <button class="btn start-btn" onclick="startQuiz()">ÌÄ¥Ï¶à ÏãúÏûë</button>
            </div>
        </div>
        
        <!-- ÌÄ¥Ï¶à ÌôîÎ©¥ -->
        <div id="quizScreen" class="hidden">
            <div class="progress-section">
                <div class="progress-info">
                    <span class="question-counter" id="questionCounter">1 / 5</span>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-title">Îã§Ïùå Îã®Ïñ¥Ïùò ÎúªÏùÄ?</div>
                <div class="english-word" id="englishWord"></div>
                <button class="sound-btn" onclick="playSound()">üîä</button>
            </div>
            
            <div class="choices-container" id="choicesContainer">
                <!-- ÏÑ†ÌÉùÏßÄÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
            </div>
            
            <button class="btn next-btn" id="nextBtn" onclick="nextQuestion()" disabled>
                Îã§Ïùå Î¨∏Ï†ú
            </button>
        </div>
        
        <!-- Í≤∞Í≥º ÌôîÎ©¥ -->
        <div id="resultsScreen" class="hidden">
            <div class="results-screen">
                <h2 class="title">ÌÄ¥Ï¶à ÏôÑÎ£å!</h2>
                <div class="score" id="finalScore">0 / 0</div>
                <div class="accuracy" id="finalAccuracy">Ï†ïÎãµÎ•†: 0%</div>
                
                <div class="results-list" id="resultsList">
                    <!-- Í≤∞Í≥º Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú ÏÉùÏÑ±Îê©ÎãàÎã§ -->
                </div>
                
                <div class="buttons-container">
                    <button class="btn retry-btn" onclick="restartQuiz()">Îã§Ïãú ÌíÄÍ∏∞</button>
                </div>
                
                <p style="margin-top: 30px; color: #666; font-size: 14px;">
                    ÌïôÏäµ Î°úÍ∑∏Í∞Ä ÏΩòÏÜîÏóê Ï∂úÎ†•ÎêòÏóàÏäµÎãàÎã§.
                </p>
            </div>
        </div>
    </div>
    <!-- END_USER_EDITABLE_HTML -->

    <!-- START_CORE_SYSTEM -->
    <!-- ÌïôÏäµ Î°úÍ∑∏ ÏãúÏä§ÌÖú -->
    <script>
        /**
 * ÌïôÏäµ Î°úÍ∑∏ Í∏∞Î°ù ÌÜµÌï© Î™®Îìà
 * Î™®Îì† ÌïôÏäµ ÌÖúÌîåÎ¶øÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî Î≤îÏö© Î°úÍ∑∏ ÏãúÏä§ÌÖú
 */

        class LearningLogger {
            constructor(options = {}) {
                this.sheetId = options.sheetId || this.extractSheetId(options.sheetUrl);
                this.webAppUrl = options.webAppUrl || 'https://script.google.com/macros/s/AKfycbx7zlKeokSY6WQdFVNRQuQIjzfNy6GXeUqWRv3k2VkvFp-GgS08PR1-ScbFv_-HLpHtRw/exec';
                this.templateId = options.templateId || 'unknown';
                this.isEnabled = options.isEnabled !== false; // Í∏∞Î≥∏Í∞í true
                this.offlineStorageKey = `learning_logs_${this.templateId}`;

                // ÏÑ∏ÏÖò Ï†ïÎ≥¥
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };

                // Ïò§ÌîÑÎùºÏù∏ Í∞êÏßÄ
                this.isOnline = navigator.onLine;
                this.setupConnectionMonitoring();

                // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Î°úÍ∑∏ Ï†ÄÏû•
                this.setupAutoSave();
            }

            /**
             * Íµ¨Í∏Ä ÏãúÌä∏ URLÏóêÏÑú ÏãúÌä∏ ID Ï∂îÏ∂ú
             */
            extractSheetId(url) {
                if (!url) return null;
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            }

            /**
             * ÌïôÏäµ ÏÑ∏ÏÖò ÏãúÏûë
             */
            startSession(studentName, additionalData = {}) {
                this.sessionData.studentName = studentName;
                this.sessionData.sessionStartTime = new Date();
                this.sessionData.additionalData = { ...additionalData };

                console.log(`üìö ÌïôÏäµ ÏÑ∏ÏÖò ÏãúÏûë: ${studentName} (${this.templateId})`);
            }

            /**
             * Ï†ïÎãµ Í∏∞Î°ù
             */
            recordCorrectAnswer() {
                this.sessionData.correctAnswers++;
            }

            /**
             * Ïò§Îãµ Í∏∞Î°ù
             */
            recordWrongAnswer() {
                this.sessionData.wrongAnswers++;
            }

            /**
             * Ïä§ÌÇµ Í∏∞Î°ù
             */
            recordSkippedAnswer() {
                this.sessionData.skippedAnswers++;
            }

            /**
             * ÌûåÌä∏ ÏÇ¨Ïö© Í∏∞Î°ù
             */
            recordHintUsed() {
                this.sessionData.hintsUsed = true;
            }

            /**
             * Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
             */
            setAdditionalData(key, value) {
                this.sessionData.additionalData[key] = value;
            }

            /**
             * ÌïôÏäµ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
             */
            calculateLearningTime() {
                if (!this.sessionData.sessionStartTime) return 0;
                const endTime = new Date();
                return Math.round((endTime - this.sessionData.sessionStartTime) / 1000); // Ï¥à Îã®ÏúÑ
            }

            /**
             * Ï†ïÏò§Îãµ Ï†ïÎ≥¥ ÏÉùÏÑ±
             */
            generateAnswerInfo() {
                const { correctAnswers, wrongAnswers, skippedAnswers } = this.sessionData;
                return `Ï†ïÎãµ:${correctAnswers}, Ïò§Îãµ:${wrongAnswers}, Ïä§ÌÇµ:${skippedAnswers}`;
            }

            /**
             * ÌïôÏäµ ÏÑ∏ÏÖò Ï¢ÖÎ£å Î∞è Î°úÍ∑∏ Ï†ÄÏû•
             */
            async endSession(additionalSessionData = {}) {
                if (!this.isEnabled) {
                    console.log('üìù Î°úÍ∑∏ Í∏∞Î°ùÏù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                    return { success: true, message: 'Î°úÍ∑∏ Í∏∞Î°ù ÎπÑÌôúÏÑ±Ìôî' };
                }

                if (!this.sessionData.studentName || !this.sessionData.sessionStartTime) {
                    console.warn('‚ö†Ô∏è ÏÑ∏ÏÖòÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    return { success: false, error: 'ÏÑ∏ÏÖòÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' };
                }

                // ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                this.sessionData.totalLearningTime = this.calculateLearningTime();
                this.sessionData.logTime = new Date();
                this.sessionData.additionalData = {
                    ...this.sessionData.additionalData,
                    ...additionalSessionData
                };

                const logData = this.formatLogData();

                try {
                    if (this.isOnline) {
                        // Ïò®ÎùºÏù∏ ÏÉÅÌÉú: Ï¶âÏãú Ï†ÑÏÜ°
                        const result = await this.sendToGoogleSheet(logData);

                        // ÏÑ±Í≥µ Ïãú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ÎèÑ Ï†ÑÏÜ° ÏãúÎèÑ
                        if (result.success) {
                            await this.sendOfflineLogs();
                        }

                        return result;
                    } else {
                        // Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú: Î°úÏª¨ Ï†ÄÏû•
                        this.saveOfflineLog(logData);
                        return {
                            success: true,
                            message: 'Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÏûÖÎãàÎã§. Î°úÍ∑∏Í∞Ä ÏûÑÏãú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.',
                            isOffline: true
                        };
                    }
                } catch (error) {
                    console.error('‚ùå Î°úÍ∑∏ Ï†ÄÏû• Ïã§Ìå®:', error);
                    this.saveOfflineLog(logData);
                    return {
                        success: false,
                        error: error.message,
                        isOffline: true
                    };
                }
            }

            /**
             * Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ (Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïª¨Îüº Íµ¨Ï°∞Ïóê ÎßûÏ∂§)
             */
            formatLogData() {
                const totalSeconds = this.sessionData.totalLearningTime;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const formattedTime = `${minutes}Î∂Ñ ${seconds}Ï¥à`;

                return {
                    Í∏∞Îä•Î™Ö: this.templateId,
                    ÌïôÏÉùÏù¥Î¶Ñ: this.sessionData.studentName,
                    Ï†ëÏÜçÏãúÍ∞Ñ: this.sessionData.sessionStartTime.toLocaleString('ko-KR'),
                    ÌïôÏäµÏãúÍ∞Ñ: formattedTime,
                    Ï†ïÏò§ÎãµÏ†ïÎ≥¥: this.generateAnswerInfo(),
                    ÌûåÌä∏ÏÇ¨Ïö©Ïó¨Î∂Ä: this.sessionData.hintsUsed,
                    Î∂ÄÍ∞ÄÏ†ïÎ≥¥: JSON.stringify(this.sessionData.additionalData),
                    Í∏∞Î°ùÏãúÍ∞Ñ: this.sessionData.logTime.toLocaleString('ko-KR')
                };
            }

            /**
             * Íµ¨Í∏Ä ÏãúÌä∏Î°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
             */
            async sendToGoogleSheet(logData) {
                try {
                    if (!this.sheetId) {
                        throw new Error('Íµ¨Í∏Ä ÏãúÌä∏ IDÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    }

                    const form = new URLSearchParams();
                    form.append('sheetId', this.sheetId);
                    form.append('menu', 'learning_log');

                    // Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                    Object.entries(logData).forEach(([key, value]) => {
                        form.append(key, value);
                    });

                    console.log('üì§ Íµ¨Í∏Ä ÏãúÌä∏Î°ú Î°úÍ∑∏ Ï†ÑÏÜ°:', logData);

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: form.toString()
                    });

                    console.log('‚úÖ Î°úÍ∑∏ Ï†ÑÏÜ° ÏôÑÎ£å');
                    return { success: true, message: 'Î°úÍ∑∏Í∞Ä Íµ¨Í∏Ä ÏãúÌä∏Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.' };

                } catch (error) {
                    console.error('‚ùå Íµ¨Í∏Ä ÏãúÌä∏ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                    throw error;
                }
            }

            /**
             * Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÄÏû•
             */
            saveOfflineLog(logData) {
                try {
                    const existingLogs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');
                    existingLogs.push({
                        ...logData,
                        savedAt: new Date().toISOString(),
                        id: Date.now() + Math.random()
                    });

                    localStorage.setItem(this.offlineStorageKey, JSON.stringify(existingLogs));
                    console.log('üíæ Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÄÏû•Îê®:', logData.Í∏∞Îä•Î™Ö);
                } catch (error) {
                    console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÄÏû• Ïã§Ìå®:', error);
                }
            }

            /**
             * Ï†ÄÏû•Îêú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ°
             */
            async sendOfflineLogs() {
                try {
                    const offlineLogs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');

                    if (offlineLogs.length === 0) {
                        return { success: true, message: 'Ï†ÑÏÜ°Ìï† Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.' };
                    }

                    console.log(`üì° ${offlineLogs.length}Í∞úÏùò Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° ÏãúÏûë`);

                    let successCount = 0;
                    for (const log of offlineLogs) {
                        try {
                            await this.sendToGoogleSheet(log);
                            successCount++;
                        } catch (error) {
                            console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                            break; // Ïã§Ìå® Ïãú Ï§ëÎã®
                        }
                    }

                    if (successCount === offlineLogs.length) {
                        // Î™®Îì† Î°úÍ∑∏ Ï†ÑÏÜ° ÏÑ±Í≥µ
                        localStorage.removeItem(this.offlineStorageKey);
                        console.log('‚úÖ Î™®Îì† Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° ÏôÑÎ£å');
                        return { success: true, message: `${successCount}Í∞úÏùò Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏Í∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.` };
                    } else {
                        // ÏùºÎ∂ÄÎßå ÏÑ±Í≥µ
                        const remainingLogs = offlineLogs.slice(successCount);
                        localStorage.setItem(this.offlineStorageKey, JSON.stringify(remainingLogs));
                        return {
                            success: false,
                            message: `${successCount}Í∞ú Ï†ÑÏÜ°Îê®, ${remainingLogs.length}Í∞ú ÎÇ®Ïùå`
                        };
                    }

                } catch (error) {
                    console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° Ïò§Î•ò:', error);
                    return { success: false, error: error.message };
                }
            }

            /**
             * ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
             */
            setupConnectionMonitoring() {
                window.addEventListener('online', () => {
                    console.log('üåê Ïò®ÎùºÏù∏ ÏÉÅÌÉúÎ°ú Ï†ÑÌôò');
                    this.isOnline = true;
                    this.sendOfflineLogs(); // ÏûêÎèôÏúºÎ°ú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ°
                });

                window.addEventListener('offline', () => {
                    console.log('üìµ Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÎ°ú Ï†ÑÌôò');
                    this.isOnline = false;
                });
            }

            /**
             * ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú ÏûêÎèô Ï†ÄÏû• ÏÑ§Ï†ï
             */
            setupAutoSave() {
                window.addEventListener('beforeunload', () => {
                    // ÏÑ∏ÏÖòÏù¥ ÏßÑÌñâ Ï§ëÏù¥Î©¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ°ú Î°úÍ∑∏ Ï†ÄÏû•
                    if (this.sessionData.sessionStartTime && !this.sessionData.logTime) {
                        const logData = this.formatLogData();
                        logData.Î∂ÄÍ∞ÄÏ†ïÎ≥¥ = JSON.stringify({
                            ...this.sessionData.additionalData,
                            autoSaved: true,
                            reason: 'page_unload'
                        });
                        this.saveOfflineLog(logData);
                    }
                });
            }

            /**
             * Î°úÍ∑∏ Í∏∞Îä• ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
             */
            setEnabled(enabled) {
                this.isEnabled = enabled;
                console.log(`üìù Î°úÍ∑∏ Í∏∞Î°ù ${enabled ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
            }

            /**
             * Ï†ÄÏû•Îêú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Í∞úÏàò ÌôïÏù∏
             */
            getOfflineLogCount() {
                try {
                    const logs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');
                    return logs.length;
                } catch {
                    return 0;
                }
            }

            /**
             * ÏÑ∏ÏÖò Ï¥àÍ∏∞Ìôî
             */
            resetSession() {
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };
            }
        }

        // Ï†ÑÏó≠ÏóêÏÑú ÏÇ¨Ïö© Í∞ÄÎä•ÌïòÎèÑÎ°ù ÏÑ§Ï†ï
        if (typeof window !== 'undefined') {
            window.LearningLogger = LearningLogger;
        }

        // Node.js ÌôòÍ≤ΩÏóêÏÑúÎèÑ ÏÇ¨Ïö© Í∞ÄÎä•
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = LearningLogger;
        }


    </script>
    <script>
    // Ï†ÑÏó≠ Î°úÍ±∞ Ïù∏Ïä§ÌÑ¥Ïä§
    let globalLogger = null;

    /**
    * ÌïôÏäµ Î°úÍ±∞ Ï¥àÍ∏∞Ìôî
    * @param {Object} options - ÏÑ§Ï†ï ÏòµÏÖò
    * @param {string} options.templateId - ÌÖúÌîåÎ¶ø ÏãùÎ≥ÑÏûê (ÌïÑÏàò)
    * @param {string} options.sheetUrl - Íµ¨Í∏Ä ÏãúÌä∏ URL (ÏÑ†ÌÉù)
    * @param {string} options.sheetId - Íµ¨Í∏Ä ÏãúÌä∏ ID (ÏÑ†ÌÉù)
    * @param {boolean} options.isEnabled - Î°úÍ∑∏ Í∏∞Îä• ÌôúÏÑ±Ìôî Ïó¨Î∂Ä (Í∏∞Î≥∏Í∞í: true)
    * @param {string} options.webAppUrl - Apps Script Web App URL (ÏÑ†ÌÉù)
    */
    function initLearningLogger(options = {}) {
    // Í∏∞Î≥∏ ÌÖúÌîåÎ¶ø ID ÏÑ§Ï†ï
    if (!options.templateId) {
    // HTML ÌååÏùºÎ™ÖÏóêÏÑú ÌÖúÌîåÎ¶ø ID Ï∂îÏ∂ú
    const fileName = window.location.pathname.split('/').pop();
    options.templateId = fileName.replace('.html', '').replace('-template', '');
    }

    try {
    globalLogger = new LearningLogger(options);
    console.log(`‚úÖ ÌïôÏäµ Î°úÍ±∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å: ${options.templateId}`);

    // Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Í∞úÏàò ÌôïÏù∏ Î∞è ÌëúÏãú
    const offlineCount = globalLogger.getOfflineLogCount();
    if (offlineCount > 0) {
    showLoggerStatus(`üì¶ Ï†ÄÏû•Îêú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ ${offlineCount}Í∞úÍ∞Ä ÏûàÏäµÎãàÎã§.`, 'info');
    }

    return true;
    } catch (error) {
    console.error('‚ùå ÌïôÏäµ Î°úÍ±∞ Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
    showLoggerStatus('Î°úÍ∑∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞ÌôîÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.', 'error');
    return false;
    }
    }

    /**
    * ÌïôÏäµ ÏÑ∏ÏÖò ÏãúÏûë
    * @param {string} studentName - ÌïôÏÉù Ïù¥Î¶Ñ
    * @param {Object} additionalData - Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞
    */
    function startLearning(studentName, additionalData = {}) {
    if (!globalLogger) {
    console.warn('‚ö†Ô∏è Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
    return false;
    }

    if (!studentName || studentName.trim() === '') {
    showLoggerStatus('ÌïôÏÉù Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
    return false;
    }

    globalLogger.startSession(studentName.trim(), additionalData);
    showLoggerStatus(`ÌïôÏäµ ÏãúÏûë: ${studentName}`, 'success');
    return true;
    }

    /**
    * ÎãµÎ≥Ä Í∏∞Î°ù (ÌÜµÌï© Ïù∏ÌÑ∞ÌéòÏù¥Ïä§)
    * @param {string|boolean} result - 'correct', 'wrong', 'skip' ÎòêÎäî true/false
    * @param {Object} additionalData - Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞
    */
    function recordAnswer(result, additionalData = {}) {
    if (!globalLogger) {
    console.warn('‚ö†Ô∏è Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
    return false;
    }

    // Î¨∏ÏûêÏó¥ ÎòêÎäî Î∂àÎ¶∞Í∞í Ï≤òÎ¶¨
    switch(result) {
    case 'correct':
    case true:
    globalLogger.recordCorrectAnswer();
    break;
    case 'wrong':
    case false:
    globalLogger.recordWrongAnswer();
    break;
    case 'skip':
    globalLogger.recordSkippedAnswer();
    break;
    default:
    console.warn('‚ö†Ô∏è Ïïå Ïàò ÏóÜÎäî ÎãµÎ≥Ä Í≤∞Í≥º:', result);
    return false;
    }

    // Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÏÑ§Ï†ï
    Object.entries(additionalData).forEach(([key, value]) => {
    globalLogger.setAdditionalData(key, value);
    });

    return true;
    }

    /**
    * ÌûåÌä∏ ÏÇ¨Ïö© Í∏∞Î°ù
    */
    function recordHintUsed() {
    if (!globalLogger) {
    console.warn('‚ö†Ô∏è Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
    return false;
    }

    globalLogger.recordHintUsed();
    return true;
    }

    /**
    * Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
    * @param {string|Object} key - ÌÇ§ ÎòêÎäî Í∞ùÏ≤¥
    * @param {any} value - Í∞í (keyÍ∞Ä Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞)
    */
    function setLogData(key, value) {
    if (!globalLogger) {
    console.warn('‚ö†Ô∏è Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
    return false;
    }

    if (typeof key === 'object') {
    // Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ Î™®Îì† ÌÇ§-Í∞í Ïåç ÏÑ§Ï†ï
    Object.entries(key).forEach(([k, v]) => {
    globalLogger.setAdditionalData(k, v);
    });
    } else {
    // Î¨∏ÏûêÏó¥Ïù∏ Í≤ΩÏö∞ Îã®Ïùº ÌÇ§-Í∞í ÏÑ§Ï†ï
    globalLogger.setAdditionalData(key, value);
    }

    return true;
    }

    /**
    * ÌïôÏäµ ÏÑ∏ÏÖò Ï¢ÖÎ£å Î∞è Î°úÍ∑∏ Ï†ÄÏû•
    * @param {Object} finalData - ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞
    */
    async function endLearning(finalData = {}) {
    if (!globalLogger) {
    console.warn('‚ö†Ô∏è Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
    return { success: false, error: 'Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' };
    }

    showLoggerStatus('ÌïôÏäµ Í≤∞Í≥ºÎ•º Ï†ÄÏû•ÌïòÎäî Ï§ë...', 'info');

    try {
    const result = await globalLogger.endSession(finalData);

    if (result.success) {
    if (result.isOffline) {
    showLoggerStatus('Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÏûÖÎãàÎã§. Ïò®ÎùºÏù∏ Î≥µÍ∑Ä Ïãú ÏûêÎèô Ï†ÑÏÜ°Îê©ÎãàÎã§.', 'warning');
    } else {
    showLoggerStatus('ÌïôÏäµ Í≤∞Í≥ºÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!', 'success');
    }
    } else {
    showLoggerStatus(`Ï†ÄÏû• Ïã§Ìå®: ${result.error}`, 'error');
    }

    return result;
    } catch (error) {
    console.error('‚ùå ÌïôÏäµ Ï¢ÖÎ£å Ï≤òÎ¶¨ Ïò§Î•ò:', error);
    showLoggerStatus('ÌïôÏäµ Í≤∞Í≥º Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    return { success: false, error: error.message };
    }
    }

    /**
    * Î°úÍ∑∏ Í∏∞Îä• ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
    * @param {boolean} enabled - ÌôúÏÑ±Ìôî Ïó¨Î∂Ä
    */
    function setLoggingEnabled(enabled) {
    if (globalLogger) {
    globalLogger.setEnabled(enabled);
    showLoggerStatus(`Î°úÍ∑∏ Í∏∞Î°ùÏù¥ ${enabled ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}ÎêòÏóàÏäµÎãàÎã§.`, 'info');
    }
    }

    /**
    * Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ ÏàòÎèô Ï†ÑÏÜ°
    */
    async function sendOfflineLogs() {
    if (!globalLogger) {
    console.warn('‚ö†Ô∏è Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
    return { success: false, error: 'Î°úÍ±∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' };
    }

    showLoggerStatus('Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏Î•º Ï†ÑÏÜ°ÌïòÎäî Ï§ë...', 'info');

    try {
    const result = await globalLogger.sendOfflineLogs();

    if (result.success) {
    showLoggerStatus(result.message, 'success');
    } else {
    showLoggerStatus(`Ï†ÑÏÜ° Ïã§Ìå®: ${result.message}`, 'error');
    }

    return result;
    } catch (error) {
    console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° Ïò§Î•ò:', error);
    showLoggerStatus('Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.', 'error');
    return { success: false, error: error.message };
    }
    }

    /**
    * Î°úÍ±∞ ÏÉÅÌÉú Î©îÏãúÏßÄ ÌëúÏãú
    * @param {string} message - Î©îÏãúÏßÄ
    * @param {string} type - ÌÉÄÏûÖ ('success', 'error', 'warning', 'info')
    */
    function showLoggerStatus(message, type = 'info') {
    console.log(`üìù [Logger] ${message}`);

    // Í∏∞Ï°¥ ÏÉÅÌÉú ÏöîÏÜåÍ∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏
    let statusElement = document.getElementById('logger-status');

    if (!statusElement) {
    // ÏÉÅÌÉú ÌëúÏãú ÏöîÏÜå ÏÉùÏÑ±
    statusElement = document.createElement('div');
    statusElement.id = 'logger-status';
    statusElement.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    max-width: 350px;
    z-index: 9999;
    opacity: 0;
    transition: all 0.3s ease;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;
    document.body.appendChild(statusElement);
    }

    // ÌÉÄÏûÖÎ≥Ñ Ïä§ÌÉÄÏùº ÏÑ§Ï†ï
    const styles = {
    success: 'background: #10B981; color: white;',
    error: 'background: #EF4444; color: white;',
    warning: 'background: #F59E0B; color: white;',
    info: 'background: #3B82F6; color: white;'
    };

    statusElement.style.cssText += styles[type] || styles.info;
    statusElement.textContent = message;
    statusElement.style.opacity = '1';

    // 3Ï¥à ÌõÑ ÏûêÎèô Ïà®ÍπÄ
    setTimeout(() => {
    statusElement.style.opacity = '0';
    }, 3000);
    }

    /**
    * Í∞ÑÌé∏Ìïú ÏÖãÏóÖ Ìï®Ïàò - Í∏∞Î≥∏ ÏÑ§Ï†ïÏúºÎ°ú Îπ†Î•¥Í≤å ÏãúÏûë
    * @param {string} templateId - ÌÖúÌîåÎ¶ø ID
    * @param {string} sheetUrl - Íµ¨Í∏Ä ÏãúÌä∏ URL (ÏÑ†ÌÉù)
    */
    function quickSetupLogger(templateId, sheetUrl = null) {
    const options = { templateId };
    if (sheetUrl) options.sheetUrl = sheetUrl;

    return initLearningLogger(options);
    }

    /**
    * HTML ÌèºÏóêÏÑú ÏûêÎèôÏúºÎ°ú ÌïôÏäµ ÏãúÏûë
    * @param {string} nameInputId - Ïù¥Î¶Ñ ÏûÖÎ†• ÌïÑÎìú ID
    * @param {Object} additionalData - Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞
    */
    function startLearningFromForm(nameInputId = 'studentName', additionalData = {}) {
    const nameInput = document.getElementById(nameInputId);
    if (!nameInput) {
    showLoggerStatus(`Ïù¥Î¶Ñ ÏûÖÎ†• ÌïÑÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: ${nameInputId}`, 'error');
    return false;
    }

    const studentName = nameInput.value.trim();
    return startLearning(studentName, additionalData);
    }

    /**
    * ÌòÑÏû¨ ÌïôÏäµ ÏÉÅÌÉú ÌôïÏù∏
    */
    function getLearningStatus() {
    if (!globalLogger) {
    return { initialized: false };
    }

    return {
    initialized: true,
    sessionActive: !!globalLogger.sessionData.sessionStartTime,
    studentName: globalLogger.sessionData.studentName,
    correctAnswers: globalLogger.sessionData.correctAnswers,
    wrongAnswers: globalLogger.sessionData.wrongAnswers,
    skippedAnswers: globalLogger.sessionData.skippedAnswers,
    hintsUsed: globalLogger.sessionData.hintsUsed,
    offlineLogCount: globalLogger.getOfflineLogCount(),
    isOnline: globalLogger.isOnline
    };
    }

    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏûêÎèô Ï¥àÍ∏∞Ìôî (ÏÑ†ÌÉùÏ†Å)
    if (typeof window !== 'undefined') {
    // Ï†ÑÏó≠ Ìï®ÏàòÎ°ú Îì±Î°ù
    window.initLearningLogger = initLearningLogger;
    window.startLearning = startLearning;
    window.recordAnswer = recordAnswer;
    window.recordHintUsed = recordHintUsed;
    window.setLogData = setLogData;
    window.endLearning = endLearning;
    window.setLoggingEnabled = setLoggingEnabled;
    window.sendOfflineLogs = sendOfflineLogs;
    window.showLoggerStatus = showLoggerStatus;
    window.quickSetupLogger = quickSetupLogger;
    window.startLearningFromForm = startLearningFromForm;
    window.getLearningStatus = getLearningStatus;
    }

    // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®ÏàòÎì§
    const LoggerUtils = {
    // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ
    formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    },

    // Ï†ïÎãµÎ•† Í≥ÑÏÇ∞
    calculateAccuracy(correct, total) {
    if (total === 0) return 0;
    return Math.round((correct / total) * 100);
    },

    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄ Ï†ïÎ¶¨
    clearOfflineLogs() {
    if (globalLogger) {
    localStorage.removeItem(globalLogger.offlineStorageKey);
    showLoggerStatus('Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.', 'info');
    }
    }
    };

    if (typeof window !== 'undefined') {
    window.LoggerUtils = LoggerUtils;
    }
    </script>
    <!-- END_CORE_SYSTEM -->
    
    <!-- START_USER_EDITABLE_DATA -->
    <script>
        const quizData = [{"english":"january","correctAnswer":"1Ïõî","choices":["1Ïõî","ÎßàÎã¥","ÎØ∏ÌÑ∞","ÌååÏö¥Îìú"]},{"english":"quid","correctAnswer":"ÌååÏö¥Îìú","choices":["Í∞§Îü∞","ÌååÏö¥Îìú","ÎØ∏ÌÑ∞","1Ïõî"]},{"english":"madam","correctAnswer":"ÎßàÎã¥","choices":["ÎØ∏ÌÑ∞","ÎßàÎã¥","Í∞§Îü∞","ÌååÏö¥Îìú"]},{"english":"gallon","correctAnswer":"Í∞§Îü∞","choices":["1Ïõî","ÌååÏö¥Îìú","ÎßàÎã¥","Í∞§Îü∞"]},{"english":"meter","correctAnswer":"ÎØ∏ÌÑ∞","choices":["ÎØ∏ÌÑ∞","1Ïõî","ÌååÏö¥Îìú","Í∞§Îü∞"]}];
    </script>
    <!-- END_USER_EDITABLE_DATA -->

    <!-- START_USER_EDITABLE_LOGIC -->
    <script>
        let currentQuestionIndex = 0;
        let score = 0;
        let userAnswers = [];
        let learnerName = '';
        let startTime = new Date();
        let selectedChoice = null;
        let currentSchoolLevel = '';
        let currentTeacherEmail = '';
        
        // Î°úÍ±∞ Ïù∏Ïä§ÌÑ¥Ïä§ Ï†ÄÏû•Ïö© Î≥ÄÏàò
        let logger = null;
        
        function startQuiz() {
            learnerName = document.getElementById('learnerName').value.trim();
            
            if (!learnerName) {
                alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }
            
            // ÌÖúÌîåÎ¶ø Î≥ÄÏàòÏóêÏÑú ÌïôÍµêÍ∏âÍ≥º ÌïôÎÖÑ Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            const schoolLevel = 'elementary';
            const grade = '3';
            
            // Ï†ÑÏó≠ Î≥ÄÏàòÏóê Ï†ÄÏû•
            window.currentSchoolLevel = schoolLevel;
            window.currentGrade = grade;
            
            // ÌÖúÌîåÎ¶ø Î≥ÄÏàòÏóêÏÑú ÏãúÌä∏ URL Í∞ÄÏ†∏Ïò§Í∏∞
            const sheetUrl = 'https://docs.google.com/spreadsheets/d/1cdlLcI6MeTlPDUbyjoZ5KLXPQGgZ6PIfkgWiXJNYlqc/edit?usp=sharing';
            
            // Î°úÍ±∞ Ï¥àÍ∏∞Ìôî (ÏãúÌä∏ URLÏù¥ ÏûàÎäî Í≤ΩÏö∞ÏóêÎßå)
            const isLoggingEnabled = sheetUrl && sheetUrl.length > 0 && !sheetUrl.includes('{{');
            if (isLoggingEnabled) {
                try {
                    initLearningLogger({
                        templateId: 'multiple-choice-quiz',
                        sheetUrl: sheetUrl,
                        isEnabled: true
                    });
                    
                    // Î°úÍ∑∏ ÏãúÏä§ÌÖúÏóê ÌïôÏäµ ÏãúÏûë Í∏∞Î°ù
                    window.startLearning(learnerName, {
                        totalQuestions: quizData.length,
                        studyType: 'multiple-choice-quiz',
                        schoolLevel: schoolLevel,
                        grade: grade
                    });
                } catch (error) {
                    console.warn('Î°úÍ∑∏ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî Ïã§Ìå®:', error);
                }
            }
            
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('quizScreen').classList.remove('hidden');
            
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            startTime = new Date();
            
            showQuestion();
        }
        
        function showQuestion() {
            if (currentQuestionIndex >= quizData.length) {
                showResults();
                return;
            }
            
            const question = quizData[currentQuestionIndex];
            selectedChoice = null;
            
            // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
            const progress = ((currentQuestionIndex + 1) / quizData.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('questionCounter').textContent = `${currentQuestionIndex + 1} / ${quizData.length}`;
            
            // ÏòÅÏñ¥ Îã®Ïñ¥ ÌëúÏãú
            document.getElementById('englishWord').textContent = question.english;
            
            // ÏÑ†ÌÉùÏßÄ ÏÉùÏÑ±
            const choicesContainer = document.getElementById('choicesContainer');
            choicesContainer.innerHTML = '';
            
            question.choices.forEach((choice, index) => {
                const choiceButton = document.createElement('button');
                choiceButton.className = 'choice';
                choiceButton.innerHTML = `<span class="choice-letter">${String.fromCharCode(65 + index)}.</span>${choice}`;
                choiceButton.onclick = () => selectChoice(choiceButton, choice);
                choicesContainer.appendChild(choiceButton);
            });
            
            // Îã§Ïùå Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            document.getElementById('nextBtn').disabled = true;
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.textContent = currentQuestionIndex < quizData.length - 1 ? 'Îã§Ïùå Î¨∏Ï†ú' : 'Í≤∞Í≥º Î≥¥Í∏∞';
        }
        
        function selectChoice(choiceElement, selectedAnswer) {
            if (selectedChoice !== null) return; // Ïù¥ÎØ∏ ÏÑ†ÌÉùÌñàÏúºÎ©¥ Î¨¥Ïãú
            
            selectedChoice = selectedAnswer;
            const question = quizData[currentQuestionIndex];
            const isCorrect = selectedAnswer === question.correctAnswer;
            
            // Î™®Îì† ÏÑ†ÌÉùÏßÄ ÎπÑÌôúÏÑ±Ìôî
            const choices = document.querySelectorAll('.choice');
            choices.forEach(choice => {
                choice.classList.add('disabled');
                const choiceText = choice.textContent.substring(2); // "A. " Î∂ÄÎ∂Ñ Ï†úÍ±∞
                
                if (choiceText === question.correctAnswer) {
                    choice.classList.add('correct');
                } else if (choiceText === selectedAnswer && !isCorrect) {
                    choice.classList.add('wrong');
                }
            });
            
            // Î°úÍ∑∏ ÏãúÏä§ÌÖúÏóê ÎãµÎ≥Ä Í∏∞Î°ù (Î°úÍ∑∏Í∞Ä ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞Îßå)
            if (typeof recordAnswer === 'function') {
                try {
                    recordAnswer(isCorrect ? 'correct' : 'wrong', {
                        questionIndex: currentQuestionIndex,
                        english: question.english,
                        correctAnswer: question.correctAnswer,
                        selectedAnswer: selectedAnswer,
                        isCorrect: isCorrect
                    });
                } catch (error) {
                    console.warn('Î°úÍ∑∏ Í∏∞Î°ù Ïã§Ìå®:', error);
                }
            }
            
            // ÎãµÏïà Í∏∞Î°ù
            userAnswers.push({
                question: question.english,
                selectedAnswer: selectedAnswer,
                correctAnswer: question.correctAnswer,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                score++;
            }
            
            // Îã§Ïùå Î≤ÑÌäº ÌôúÏÑ±Ìôî
            document.getElementById('nextBtn').disabled = false;
        }
        
        function nextQuestion() {
            currentQuestionIndex++;
            showQuestion();
        }
        
        function playSound() {
            const question = quizData[currentQuestionIndex];
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(question.english);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }
        
        function showResults() {
            document.getElementById('quizScreen').classList.add('hidden');
            document.getElementById('resultsScreen').classList.remove('hidden');
            
            const totalQuestions = quizData.length;
            const accuracy = Math.round((score / totalQuestions) * 100);
            
            document.getElementById('finalScore').textContent = `${score} / ${totalQuestions}`;
            document.getElementById('finalAccuracy').textContent = `Ï†ïÎãµÎ•†: ${accuracy}%`;
            
            // Í≤∞Í≥º Î™©Î°ù ÏÉùÏÑ±
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';
            
            userAnswers.forEach((answer, index) => {
                const resultItem = document.createElement('div');
                resultItem.className = `result-item ${answer.isCorrect ? 'correct' : 'wrong'}`;
                
                let answerText = '';
                if (answer.isCorrect) {
                    answerText = `<div class="result-answer">ÏÑ†ÌÉùÌïú Îãµ: <span class="result-correct-answer">${answer.selectedAnswer}</span></div>`;
                } else {
                    answerText = `
                        <div class="result-answer">ÏÑ†ÌÉùÌïú Îãµ: <span class="result-wrong-answer">${answer.selectedAnswer}</span></div>
                        <div class="result-answer">Ï†ïÎãµ: <span class="result-correct-answer">${answer.correctAnswer}</span></div>
                    `;
                }
                
                resultItem.innerHTML = `
                    <div class="result-word">${answer.question}</div>
                    ${answerText}
                `;
                
                resultsList.appendChild(resultItem);
            });
            
            // ÏÉàÎ°úÏö¥ Î°úÍ∑∏ ÏãúÏä§ÌÖúÏúºÎ°ú ÌïôÏäµ ÏôÑÎ£å Í∏∞Î°ù
            logLearningData();
        }
        
        async function logLearningData() {
            const totalQuestions = quizData.length;
            const accuracy = Math.round((score / totalQuestions) * 100);
            
            // ÏÉàÎ°úÏö¥ Î°úÍ∑∏ ÏãúÏä§ÌÖúÏúºÎ°ú ÌïôÏäµ ÏôÑÎ£å Í∏∞Î°ù (Î°úÍ∑∏Í∞Ä ÌôúÏÑ±ÌôîÎêú Í≤ΩÏö∞Îßå)
            if (typeof endLearning === 'function') {
                try {
                    const logResult = await endLearning({
                        finalAccuracy: accuracy,
                        finalScore: `${score}/${totalQuestions}`,
                        schoolLevel: currentSchoolLevel,
                        teacherEmail: currentTeacherEmail,
                        detailedAnswers: JSON.stringify(userAnswers),
                        studyMethod: 'multiple-choice-quiz'
                    });
                    
                    // Î°úÍ∑∏ Ï†ÄÏû• Í≤∞Í≥º ÌëúÏãú
                    if (logResult.success) {
                        if (logResult.isOffline) {
                            console.log('üì± Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÏûÖÎãàÎã§. Ïò®ÎùºÏù∏ Î≥µÍ∑Ä Ïãú ÏûêÎèô Ï†ÑÏÜ°Îê©ÎãàÎã§.');
                        } else {
                            console.log('‚úÖ ÌïôÏäµ Í≤∞Í≥ºÍ∞Ä Íµ¨Í∏Ä ÏãúÌä∏Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!');
                        }
                    } else {
                        console.error('‚ùå Ï†ÄÏû• Ïã§Ìå®:', logResult.error);
                    }
                } catch (error) {
                    console.warn('Î°úÍ∑∏ Ï¢ÖÎ£å Ïã§Ìå®:', error);
                }
            } else {
                console.log('üìù Î°úÍ∑∏ ÏãúÏä§ÌÖúÏù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
            }
        }
        
        // Í∏∞Ï°¥ saveToGoogleSheet Ìï®ÏàòÎì§ÏùÄ ÏÉàÎ°úÏö¥ ÌÜµÌï© Î°úÍ∑∏ ÏãúÏä§ÌÖúÏúºÎ°ú ÎåÄÏ≤¥Îê®
        
        function restartQuiz() {
            document.getElementById('resultsScreen').classList.add('hidden');
            document.getElementById('startScreen').classList.remove('hidden');
            
            // Ï¥àÍ∏∞Ìôî
            document.getElementById('learnerName').value = '';
            currentQuestionIndex = 0;
            score = 0;
            userAnswers = [];
            selectedChoice = null;
        }
        
        // ÏóîÌÑ∞ÌÇ§Î°ú ÌÄ¥Ï¶à ÏãúÏûë
        document.getElementById('learnerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                startQuiz();
            }
        });
    </script>
    <!-- END_USER_EDITABLE_LOGIC -->
</body>
</html>