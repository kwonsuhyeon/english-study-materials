<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì–´ ì‰ë„ì‰ í•™ìŠµ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Taurus, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 800px;
            width: 100%;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .header {
            margin-bottom: 30px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: #718096;
            margin-bottom: 20px;
        }

        .name-input-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-group input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .start-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .start-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .start-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .learning-section {
            display: none;
        }

        .passage-info {
            background: #f7fafc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 2px solid #e2e8f0;
        }

        .passage-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .progress-info {
            font-size: 1rem;
            color: #4a5568;
            margin-bottom: 15px;
        }

        .sentence-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .sentence-text {
            font-size: 1.4rem;
            line-height: 1.8;
            color: #2d3748;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }

        .audio-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .audio-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .audio-button:hover:not(:disabled) {
            background: #5a67d8;
        }

        .audio-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .speed-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .speed-button {
            background: #718096;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .speed-button.active {
            background: #667eea;
        }

        .recording-section {
            margin-top: 25px;
        }

        .record-button {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto 20px;
            min-width: 200px;
        }

        .record-button:hover:not(:disabled) {
            background: #c53030;
            transform: scale(1.05);
        }

        .record-button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .record-button.recording {
            background: #38a169;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .feedback-section {
            margin-top: 25px;
            display: none;
        }

        .accuracy-score {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .accuracy-score.excellent {
            color: #38a169;
        }

        .accuracy-score.good {
            color: #3182ce;
        }

        .accuracy-score.fair {
            color: #d69e2e;
        }

        .accuracy-score.poor {
            color: #e53e3e;
        }

        .user-speech {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-style: italic;
            color: #4a5568;
        }

        .word-feedback {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }

        .word {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: 500;
        }

        .word.correct {
            background: #c6f6d5;
            color: #2f855a;
        }

        .word.incorrect {
            background: #fed7d7;
            color: #c53030;
        }

        .next-button {
            background: #38a169;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
        }

        .next-button:hover {
            background: #2f855a;
        }

        .retry-button {
            background: #ed8936;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin: 10px;
        }

        .retry-button:hover {
            background: #dd6b20;
        }

        .completion-section {
            display: none;
            text-align: center;
        }

        .completion-title {
            font-size: 2rem;
            font-weight: bold;
            color: #38a169;
            margin-bottom: 20px;
        }

        .final-stats {
            background: #f0fff4;
            border: 2px solid #38a169;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #c6f6d5;
        }

        .stats-item:last-child {
            border-bottom: none;
        }

        .stats-label {
            font-weight: 600;
            color: #2f855a;
        }

        .stats-value {
            font-weight: bold;
            color: #1a202c;
        }

        .restart-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .restart-button:hover {
            background: #5a67d8;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .sentence-text {
                font-size: 1.2rem;
            }
            
            .audio-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì´ë¦„ ì…ë ¥ ì„¹ì…˜ -->
        <div class="name-input-section" id="nameInputSection">
            <div class="header">
                <h1 class="title">ğŸ¯ ì˜ì–´ ì‰ë„ì‰ í•™ìŠµ</h1>
                <p class="subtitle">ì„ íƒëœ ë¬¸ì¥ ì‰ë„ì‰</p>
                <p class="subtitle">ë¬¸ì¥ë³„ ë°œìŒ ì—°ìŠµìœ¼ë¡œ ì˜ì–´ ì‹¤ë ¥ì„ í–¥ìƒì‹œí‚¤ì„¸ìš”</p>
            </div>

            <div class="input-group">
                <label for="userName">í•™ìŠµì ì´ë¦„</label>
                <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
            </div>

            <button class="start-button" onclick="startLearning()">í•™ìŠµ ì‹œì‘í•˜ê¸°</button>
        </div>

        <!-- í•™ìŠµ ì„¹ì…˜ -->
        <div class="learning-section" id="learningSection">
            <div class="passage-info">
                <div class="passage-title">ì„ íƒëœ ë¬¸ì¥ ì‰ë„ì‰</div>
                <div class="progress-info">
                    <span id="currentSentence">1</span> / <span id="totalSentences">3</span> ë¬¸ì¥
                </div>
            </div>

            <div class="sentence-container">
                <div class="sentence-text" id="sentenceText">
                    Today, I will tell you about my favorite hobby
                </div>

                <div class="audio-controls">
                    <button class="audio-button" id="playButton" onclick="playAudio()">
                        ğŸ”Š ì¬ìƒ
                    </button>
                    <div class="speed-controls">
                        <span>ì†ë„:</span>
                        <button class="speed-button" onclick="setSpeed(0.75)">0.75x</button>
                        <button class="speed-button active" onclick="setSpeed(1.0)">1.0x</button>
                        <button class="speed-button" onclick="setSpeed(1.25)">1.25x</button>
                    </div>
                </div>

                <div class="recording-section">
                    <button class="record-button" id="recordButton" onclick="toggleRecording()">
                        ğŸ¤ ë…¹ìŒ ì‹œì‘
                    </button>
                    
                    <div class="error-message" id="errorMessage"></div>
                </div>

                <div class="feedback-section" id="feedbackSection">
                    <div class="accuracy-score" id="accuracyScore">85%</div>
                    
                    <div class="user-speech-container">
                        <strong>ì¸ì‹ëœ ìŒì„±:</strong>
                        <div class="user-speech" id="userSpeech"></div>
                    </div>

                    <div class="word-feedback" id="wordFeedback"></div>

                    <div>
                        <button class="next-button" id="nextButton" onclick="nextSentence()" style="display: none;">
                            ë‹¤ìŒ ë¬¸ì¥
                        </button>
                        <button class="retry-button" onclick="retrySentence()">
                            ë‹¤ì‹œ ì‹œë„
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì™„ë£Œ ì„¹ì…˜ -->
        <div class="completion-section" id="completionSection">
            <div class="completion-title">ğŸ‰ í•™ìŠµ ì™„ë£Œ!</div>
            
            <div class="final-stats">
                <div class="stats-item">
                    <span class="stats-label">ì´ ë¬¸ì¥ ìˆ˜</span>
                    <span class="stats-value" id="finalTotalSentences">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">í†µê³¼í•œ ë¬¸ì¥</span>
                    <span class="stats-value" id="finalPassedSentences">0</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">í‰ê·  ì •í™•ë„</span>
                    <span class="stats-value" id="finalAverageAccuracy">0%</span>
                </div>
                <div class="stats-item">
                    <span class="stats-label">í•™ìŠµ ì‹œê°„</span>
                    <span class="stats-value" id="finalLearningTime">0ë¶„</span>
                </div>
            </div>

            <button class="restart-button" onclick="restartLearning()">
                ë‹¤ì‹œ í•™ìŠµí•˜ê¸°
            </button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentSentenceIndex = 0;
        let sentences = ["Today, I will tell you about my favorite hobby","I love painting","Painting makes me happy"];
        let passageTitle = "ì„ íƒëœ ë¬¸ì¥ ì‰ë„ì‰";
        let isRecording = false;
        let recognition = null;
        let speechSynthesis = window.speechSynthesis;
        let currentUtterance = null;
        let playbackSpeed = 1.0;
        let learningStartTime = null;
        let sentenceScores = [];
        let passedSentences = 0;

        // LearningLogger í´ë˜ìŠ¤
        class LearningLogger {
            constructor(options = {}) {
                this.webAppUrl = options.webAppUrl || 'https://script.google.com/macros/s/AKfycbx7zlKeokSY6WQdFVNRQuQIjzfNy6GXeUqWRv3k2VkvFp-GgS08PR1-ScbFv_-HLpHtRw/exec';
                this.sheetId = options.sheetId || this.extractSheetId(options.sheetUrl);
                this.isEnabled = options.isEnabled !== false;
                
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };
            }

            extractSheetId(url) {
                if (!url) return null;
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            }

            startSession(studentName, additionalData = {}) {
                this.sessionData.studentName = studentName;
                this.sessionData.sessionStartTime = new Date();
                this.sessionData.additionalData = { ...additionalData };
                console.log('ğŸ“š í•™ìŠµ ì„¸ì…˜ ì‹œì‘:', studentName);
            }

            recordCorrectAnswer() { this.sessionData.correctAnswers++; }
            recordWrongAnswer() { this.sessionData.wrongAnswers++; }
            recordSkippedAnswer() { this.sessionData.skippedAnswers++; }
            recordHintUsed() { this.sessionData.hintsUsed = true; }
            setAdditionalData(key, value) { this.sessionData.additionalData[key] = value; }

            calculateLearningTime() {
                if (!this.sessionData.sessionStartTime) return 0;
                const endTime = new Date();
                return Math.round((endTime - this.sessionData.sessionStartTime) / 1000);
            }

            async endSession(additionalSessionData = {}) {
                if (!this.isEnabled || !this.sheetId) {
                    console.log('ğŸ“ ë¡œê·¸ ê¸°ë¡ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    return { success: true, message: 'ë¡œê·¸ ê¸°ë¡ ë¹„í™œì„±í™”' };
                }

                this.sessionData.totalLearningTime = this.calculateLearningTime();
                this.sessionData.logTime = new Date();
                this.sessionData.additionalData = { ...this.sessionData.additionalData, ...additionalSessionData };

                const totalSeconds = this.sessionData.totalLearningTime;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const formattedTime = `${minutes}ë¶„ ${seconds}ì´ˆ`;

                const logData = {
                    menu: 'learning_log',
                    sheetId: this.sheetId,
                    ê¸°ëŠ¥ëª…: 'ì‰ë„ì‰ í•™ìŠµ',
                    í•™ìƒì´ë¦„: this.sessionData.studentName,
                    ì ‘ì†ì‹œê°„: this.sessionData.sessionStartTime?.toLocaleString('ko-KR') || '',
                    í•™ìŠµì‹œê°„: formattedTime,
                    ì •ì˜¤ë‹µì •ë³´: `ì •ë‹µ:${this.sessionData.correctAnswers}, ì˜¤ë‹µ:${this.sessionData.wrongAnswers}, ìŠ¤í‚µ:${this.sessionData.skippedAnswers}`,
                    íŒíŠ¸ì‚¬ìš©ì—¬ë¶€: this.sessionData.hintsUsed,
                    ë¶€ê°€ì •ë³´: JSON.stringify(this.sessionData.additionalData),
                    ê¸°ë¡ì‹œê°„: this.sessionData.logTime.toLocaleString('ko-KR')
                };

                try {
                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams(logData).toString()
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();
                    if (!result.success) throw new Error(result.error || 'ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨');

                    console.log('âœ… ë¡œê·¸ ì „ì†¡ ì™„ë£Œ');
                    return { success: true, message: 'ë¡œê·¸ê°€ êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' };
                    
                } catch (error) {
                    console.error('âŒ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', error);
                    return { success: false, error: error.message };
                }
            }

            resetSession() {
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };
            }
        }

        // í•™ìŠµ ë¡œê·¸ ê´€ë ¨
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1cdlLcI6MeTlPDUbyjoZ5KLXPQGgZ6PIfkgWiXJNYlqc/edit?usp=sharing";
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzGsSwQHKbVxqzDi9fgv93JNm8wEsvKtZZmEqwpGSL4B4Mu67SMjniRMvXHOfh3DdWg/exec";
        const learningLogger = new LearningLogger({
            sheetUrl: SHEET_URL,
            webAppUrl: WEBAPP_URL,
            isEnabled: true  // ì¼ë‹¨ í™œì„±í™”í•˜ê³  LearningLogger ë‚´ë¶€ì—ì„œ íŒë‹¨
        });
        
        // ë””ë²„ê·¸ ì •ë³´ ì¶œë ¥  
        console.log('ğŸ” ì‰ë„ì‰ ë¡œê·¸ ì„¤ì •:', {
            sheetUrl: SHEET_URL,
            webAppUrl: WEBAPP_URL,
            isTemplate: SHEET_URL === "https://docs.google.com/spreadsheets/d/1cdlLcI6MeTlPDUbyjoZ5KLXPQGgZ6PIfkgWiXJNYlqc/edit?usp=sharing",
            isEmpty: SHEET_URL.trim() === "",
            extractedSheetId: learningLogger.sheetId,
            loggerIsEnabled: learningLogger.isEnabled,
            loggerWebAppUrl: learningLogger.webAppUrl,
            hasValidSheetId: !!learningLogger.sheetId,
            hasValidWebAppUrl: !!learningLogger.webAppUrl
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpeechRecognition();
            updateDisplay();
        });

        function startLearning() {
            const userName = document.getElementById('userName').value.trim();
            if (!userName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            learningStartTime = new Date();
            document.getElementById('nameInputSection').style.display = 'none';
            document.getElementById('learningSection').style.display = 'block';
            
            // í•™ìŠµ ì„¸ì…˜ ì‹œì‘
            learningLogger.startSession(userName, {
                passageTitle: passageTitle,
                totalSentences: sentences.length,
                learningType: 'ì‰ë„ì‰'
            });

            updateDisplay();
        }

        function initializeSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onstart = function() {
                    console.log('Speech recognition started');
                };

                recognition.onresult = function(event) {
                    const result = event.results[0][0].transcript;
                    console.log('Speech recognition result:', result);
                    processSpeechResult(result);
                };

                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    showError('ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + event.error);
                    stopRecording();
                };

                recognition.onend = function() {
                    stopRecording();
                };
            } else {
                showError('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }

        function updateDisplay() {
            if (currentSentenceIndex >= sentences.length) {
                showCompletion();
                return;
            }

            document.getElementById('currentSentence').textContent = currentSentenceIndex + 1;
            document.getElementById('totalSentences').textContent = sentences.length;
            document.getElementById('sentenceText').textContent = sentences[currentSentenceIndex];
            
            // í”¼ë“œë°± ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            document.getElementById('feedbackSection').style.display = 'none';
        }

        function playAudio() {
            if (currentUtterance) {
                speechSynthesis.cancel();
            }

            const text = sentences[currentSentenceIndex];
            currentUtterance = new SpeechSynthesisUtterance(text);
            
            // ì˜ì–´ ìŒì„± ì„¤ì •
            const voices = speechSynthesis.getVoices();
            const englishVoice = voices.find(voice => 
                voice.lang.includes('en') && voice.name.includes('Google')
            ) || voices.find(voice => voice.lang.includes('en'));
            
            if (englishVoice) {
                currentUtterance.voice = englishVoice;
            }
            
            currentUtterance.rate = playbackSpeed;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;

            speechSynthesis.speak(currentUtterance);
        }

        function setSpeed(speed) {
            playbackSpeed = speed;
            
            // ì†ë„ ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.speed-button').forEach(button => {
                button.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function toggleRecording() {
            if (!recognition) {
                showError('ìŒì„± ì¸ì‹ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        function startRecording() {
            isRecording = true;
            const recordButton = document.getElementById('recordButton');
            recordButton.textContent = 'ğŸ”´ ë…¹ìŒ ì¤‘...';
            recordButton.classList.add('recording');
            
            hideError();
            recognition.start();
        }

        function stopRecording() {
            isRecording = false;
            const recordButton = document.getElementById('recordButton');
            recordButton.textContent = 'ğŸ¤ ë…¹ìŒ ì‹œì‘';
            recordButton.classList.remove('recording');
            
            if (recognition) {
                recognition.stop();
            }
        }

        function processSpeechResult(userSpeech) {
            const originalSentence = sentences[currentSentenceIndex];
            const accuracy = calculateAccuracy(originalSentence, userSpeech);
            
            // ì‚¬ìš©ì ë°œìŒ í‘œì‹œ
            document.getElementById('userSpeech').textContent = userSpeech;
            
            // ì •í™•ë„ í‘œì‹œ
            const accuracyElement = document.getElementById('accuracyScore');
            accuracyElement.textContent = Math.round(accuracy) + '%';
            
            // ì •í™•ë„ì— ë”°ë¥¸ í´ë˜ìŠ¤ ì„¤ì •
            accuracyElement.className = 'accuracy-score';
            if (accuracy >= 90) {
                accuracyElement.classList.add('excellent');
            } else if (accuracy >= 75) {
                accuracyElement.classList.add('good');
            } else if (accuracy >= 60) {
                accuracyElement.classList.add('fair');
            } else {
                accuracyElement.classList.add('poor');
            }
            
            // ë‹¨ì–´ë³„ í”¼ë“œë°± í‘œì‹œ
            showWordFeedback(originalSentence, userSpeech);
            
            // ì ìˆ˜ ê¸°ë¡
            sentenceScores.push(accuracy);
            
            // 70% ì´ìƒì´ë©´ í†µê³¼
            const isPassed = accuracy >= 70;
            if (isPassed) {
                passedSentences++;
                document.getElementById('nextButton').style.display = 'inline-block';
                learningLogger.recordCorrectAnswer();
            } else {
                learningLogger.recordWrongAnswer();
            }
            
            // í”¼ë“œë°± ì„¹ì…˜ í‘œì‹œ
            document.getElementById('feedbackSection').style.display = 'block';
            
            // ì¶”ê°€ ë°ì´í„° ì„¤ì • - ë” ìƒì„¸í•œ ì •ë³´
            learningLogger.setAdditionalData('sentence_' + (currentSentenceIndex + 1), {
                sentenceNumber: currentSentenceIndex + 1,
                originalText: originalSentence,
                userSpeech: userSpeech,
                accuracy: Math.round(accuracy),
                passed: isPassed,
                attempts: 1, // ì²« ì‹œë„ë¡œ ê¸°ë¡
                timestamp: new Date().toLocaleString('ko-KR')
            });
        }

        function calculateAccuracy(original, spoken) {
            // ë‹¨ì–´ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì—¬ ë¹„êµ
            const originalWords = original.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 0);
            const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 0);
            
            // Levenshtein Distanceë¥¼ ì´ìš©í•œ ìœ ì‚¬ë„ ê³„ì‚°
            const maxLength = Math.max(originalWords.length, spokenWords.length);
            if (maxLength === 0) return 100;
            
            const distance = levenshteinDistance(originalWords, spokenWords);
            const similarity = Math.max(0, (maxLength - distance) / maxLength);
            
            return similarity * 100;
        }

        function levenshteinDistance(arr1, arr2) {
            const matrix = Array(arr2.length + 1).fill(null).map(() =>
                Array(arr1.length + 1).fill(null)
            );

            for (let i = 0; i <= arr1.length; i++) {
                matrix[0][i] = i;
            }

            for (let j = 0; j <= arr2.length; j++) {
                matrix[j][0] = j;
            }

            for (let j = 1; j <= arr2.length; j++) {
                for (let i = 1; i <= arr1.length; i++) {
                    const indicator = arr1[i - 1] === arr2[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(
                        matrix[j][i - 1] + 1,
                        matrix[j - 1][i] + 1,
                        matrix[j - 1][i - 1] + indicator
                    );
                }
            }

            return matrix[arr2.length][arr1.length];
        }

        function showWordFeedback(original, spoken) {
            const originalWords = original.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 0);
            const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w.length > 0);
            
            const feedbackContainer = document.getElementById('wordFeedback');
            feedbackContainer.innerHTML = '';
            
            const maxLength = Math.max(originalWords.length, spokenWords.length);
            
            for (let i = 0; i < maxLength; i++) {
                const originalWord = originalWords[i] || '';
                const spokenWord = spokenWords[i] || '';
                const isCorrect = originalWord === spokenWord;
                
                const wordElement = document.createElement('span');
                wordElement.className = `word ${isCorrect ? 'correct' : 'incorrect'}`;
                wordElement.textContent = originalWord || `[${spokenWord}]`;
                
                feedbackContainer.appendChild(wordElement);
            }
        }

        function nextSentence() {
            currentSentenceIndex++;
            updateDisplay();
        }

        function retrySentence() {
            document.getElementById('feedbackSection').style.display = 'none';
        }

        async function showCompletion() {
            document.getElementById('learningSection').style.display = 'none';
            document.getElementById('completionSection').style.display = 'block';
            
            // ìµœì¢… í†µê³„ ê³„ì‚°
            const totalSentences = sentences.length;
            const averageAccuracy = sentenceScores.length > 0 
                ? sentenceScores.reduce((a, b) => a + b, 0) / sentenceScores.length 
                : 0;
            const learningTime = learningStartTime 
                ? Math.round((new Date() - learningStartTime) / 1000 / 60)
                : 0;
            
            // ìµœì¢… ê²°ê³¼ í‘œì‹œ
            document.getElementById('finalTotalSentences').textContent = totalSentences;
            document.getElementById('finalPassedSentences').textContent = passedSentences;
            document.getElementById('finalAverageAccuracy').textContent = Math.round(averageAccuracy) + '%';
            document.getElementById('finalLearningTime').textContent = learningTime + 'ë¶„';
            
            // ìµœì¢… í•™ìŠµ ë°ì´í„° ì„¤ì • ë° ì„¸ì…˜ ì¢…ë£Œ
            learningLogger.setAdditionalData('finalResults', {
                totalSentences: totalSentences,
                passedSentences: passedSentences,
                failedSentences: totalSentences - passedSentences,
                averageAccuracy: Math.round(averageAccuracy),
                sentenceScores: sentenceScores,
                completionTime: new Date().toLocaleString('ko-KR'),
                passRate: Math.round((passedSentences / totalSentences) * 100)
            });
            
            // í•™ìŠµí•œ ë¬¸ì¥ë“¤ ìš”ì•½ ì¶”ê°€
            const practicedSentences = [];
            for (let i = 0; i < sentences.length; i++) {
                const sentenceData = learningLogger.sessionData.additionalData['sentence_' + (i + 1)];
                if (sentenceData) {
                    practicedSentences.push({
                        number: i + 1,
                        original: sentences[i],
                        userSpeech: sentenceData.userSpeech || '',
                        accuracy: sentenceData.accuracy || 0,
                        passed: sentenceData.passed || false
                    });
                }
            }
            learningLogger.setAdditionalData('practicedSentences', practicedSentences);
            
            try {
                const result = await learningLogger.endSession();
                if (result.success) {
                    console.log('í•™ìŠµ ë¡œê·¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.warn('í•™ìŠµ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', result.error);
                }
            } catch (error) {
                console.error('í•™ìŠµ ë¡œê·¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        function restartLearning() {
            // ì´ˆê¸°í™”
            currentSentenceIndex = 0;
            sentenceScores = [];
            passedSentences = 0;
            learningStartTime = null;
            
            // ì„¹ì…˜ í‘œì‹œ ë³€ê²½
            document.getElementById('completionSection').style.display = 'none';
            document.getElementById('nameInputSection').style.display = 'block';
            
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('userName').value = '';
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // ìŒì„± í•©ì„± ìŒì„± ë¡œë“œ ëŒ€ê¸°
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = function() {
                console.log('Voices loaded');
            };
        }
    </script>
</body>
</html>