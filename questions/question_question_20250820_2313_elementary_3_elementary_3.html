<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î¨∏Ìï≠ÏÉùÏÑ± - elementary 3ÌïôÎÖÑ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .title {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }

        .passage-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
            display: none; /* Ï≤òÏùåÏóêÎäî Ïà®ÍπÄ */
        }
        
        .passage-section.show {
            display: block; /* ÌÄ¥Ï¶à ÏãúÏûë Ïãú ÌëúÏãú */
        }

        .passage-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .passage-content {
            line-height: 1.6;
            color: #555;
            font-size: 16px;
        }
        
        .name-input {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .name-input input {
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            width: 300px;
            text-align: center;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
            display: none;
        }
        
        .question-card.active {
            display: block;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .question-number {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .difficulty-low {
            background: #d4edda;
            color: #155724;
        }
        
        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .difficulty-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .question-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .option.correct {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .option.incorrect {
            border-color: #dc3545;
            background: #dc3545;
            color: white;
        }
        
        .explanation {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
            display: none;
        }
        
        .explanation.show {
            display: block;
        }
        
        .explanation-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }
        
        .controls {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress {
            background: #e1e5e9;
            border-radius: 20px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: #667eea;
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        
        .result-screen {
            text-align: center;
            display: none;
        }
        
        .result-screen.show {
            display: block;
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }
        
        .result-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Î¨∏Ìï≠ÏÉùÏÑ± - elementary 3ÌïôÎÖÑ</h1>
        
        <!-- ÏßÄÎ¨∏ ÏÑπÏÖò -->
        <div class="passage-section">
            <div class="passage-title">üìñ Reading Passage</div>
            <div class="passage-content">Once upon a time, there was a big, blue ball named Earth. Earth was always spinning around in space, and it was a home for all kinds of animals and people. 

One day, Earth began to feel sick. &quot;I feel so hot and heavy,&quot; it said. &quot;I need help.&quot; So, Earth asked the sun, &quot;Can you help me? It&#x27;s so hot here.&quot; But the sun answered, &quot;I can&#x27;t. I always give heat and light to everyone.&quot; 

Then, Earth asked the wind, &quot;Can you help me? I feel so heavy.&quot; But the wind said, &quot;I can&#x27;t. I am busy moving the air around.&quot; 

Earth was sad and didn&#x27;t know what to do. It felt hot and heavy because people were not taking good care of it. They were cutting down trees, which helps keep the air clean. They were also throwing dirty things into the rivers and oceans. This was making Earth sick.

Then, a small boy came. He was different from the others. He loved to plant trees and clean up the beach. When he saw the dirty rivers, he felt angry. &quot;Why are they doing this to our Earth?&quot; he asked. He decided to change things.

He started to pick up the trash and plant more trees. He also asked his friends to help. &quot;Let&#x27;s take care of our Earth,&quot; he said. &quot;It&#x27;s our home, and it&#x27;s the only one we have.&quot; His friends agreed, and they all worked together to clean up the Earth.

After some time, Earth started to feel better. It said, &quot;Thank you, boy. You and your friends have made me feel better. I am not as hot and heavy now.&quot; The boy smiled and promised to always take care of Earth.

This story teaches us that each one of us can make a big difference. We must remember to take care of our Earth because it is our home. Let&#x27;s not make it feel hot and heavy. Instead, let&#x27;s make it feel happy and healthy. Let&#x27;s save our Earth!</div>
        </div>
        
        <!-- ÏãúÏûë ÌôîÎ©¥ -->
        <div id="startScreen" class="name-input">
            <input type="text" id="userName" placeholder="Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî" />
            <button class="btn" id="startBtn" onclick="startQuiz()">ÌÄ¥Ï¶à ÏãúÏûë</button>
        </div>
        
        <!-- ÌÄ¥Ï¶à Ïª®ÌÖåÏù¥ÎÑà -->
        <div class="quiz-container" id="quizContainer">
            <!-- ÏßÑÌñâ ÏÉÅÌô© -->
            <div class="stats">
                <span id="currentQuestion">1</span> / <span id="totalQuestions">3</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <!-- Î¨∏Ï†ú Ïπ¥ÎìúÎì§ -->
            
      <div class="question-card" id="question-0">
        <div class="question-header">
          <span class="question-number">Î¨∏Ï†ú 1</span>
          <span class="difficulty-badge difficulty-low">Low</span>
        </div>
        <div class="question-text">What was the name of the big, blue ball?</div>
        <div class="options">
          <div class="option" onclick="selectOption(0, 0)">A. Earth</div><div class="option" onclick="selectOption(0, 1)">B. Sun</div><div class="option" onclick="selectOption(0, 2)">C. Moon</div><div class="option" onclick="selectOption(0, 3)">D. Wind</div>
        </div>
        <div class="explanation">
          <div class="explanation-title">üí° Ìï¥ÏÑ§</div>
          <div>ÏßÄÎ¨∏ÏóêÏÑú 'big, blue ball'ÏùÄ EarthÎ•º Í∞ÄÎ¶¨ÌÇµÎãàÎã§. Îã§Î•∏ ÏÑ†ÌÉùÏßÄÎì§ÏùÄ ÏßÄÎ¨∏Ïóê Ïñ∏Í∏âÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.<br><br>üìä <strong>ÏòàÏÉÅ Ï†ïÎãµÎ•†:</strong> 70-80%</div>
        </div>
      </div>
    
      <div class="question-card" id="question-1">
        <div class="question-header">
          <span class="question-number">Î¨∏Ï†ú 2</span>
          <span class="difficulty-badge difficulty-medium">Medium</span>
        </div>
        <div class="question-text">Why did Earth feel sick?</div>
        <div class="options">
          <div class="option" onclick="selectOption(1, 0)">A. People were taking care of it.</div><div class="option" onclick="selectOption(1, 1)">B. People were cutting down trees and polluting.</div><div class="option" onclick="selectOption(1, 2)">C. The sun was too bright.</div><div class="option" onclick="selectOption(1, 3)">D. The wind was too strong.</div>
        </div>
        <div class="explanation">
          <div class="explanation-title">üí° Ìï¥ÏÑ§</div>
          <div>ÏßÄÎ¨∏Ïóê Îî∞Î•¥Î©¥ EarthÎäî ÏÇ¨ÎûåÎì§Ïù¥ ÎÇòÎ¨¥Î•º Î≤†Í≥† ÎçîÎü¨Ïö¥ Í≤ÉÏùÑ Í∞ïÍ≥º Î∞îÎã§Ïóê Î≤ÑÎ¶¨Îäî Îì± Ïûò ÎèåÎ≥¥ÏßÄ ÏïäÏïÑÏÑú ÏïÑÌå†ÏäµÎãàÎã§.<br><br>üìä <strong>ÏòàÏÉÅ Ï†ïÎãµÎ•†:</strong> 60-70%</div>
        </div>
      </div>
    
      <div class="question-card" id="question-2">
        <div class="question-header">
          <span class="question-number">Î¨∏Ï†ú 3</span>
          <span class="difficulty-badge difficulty-high">High</span>
        </div>
        <div class="question-text">What did the small boy do to help Earth?</div>
        <div class="options">
          <div class="option" onclick="selectOption(2, 0)">A. Cut down trees</div><div class="option" onclick="selectOption(2, 1)">B. Pick up trash and plant trees</div><div class="option" onclick="selectOption(2, 2)">C. Turn off the sun</div><div class="option" onclick="selectOption(2, 3)">D. Make a new ball</div>
        </div>
        <div class="explanation">
          <div class="explanation-title">üí° Ìï¥ÏÑ§</div>
          <div>ÏÜåÎÖÑÏùÄ Ïì∞Î†àÍ∏∞Î•º Ï§çÍ≥† ÎÇòÎ¨¥Î•º Ïã¨Ïñ¥ EarthÎ•º ÎèÑÏôîÏäµÎãàÎã§. Îã§Î•∏ ÏÑ†ÌÉùÏßÄÎäî ÏßÄÎ¨∏Ïóê ÎßûÏßÄ ÏïäÏäµÎãàÎã§.<br><br>üìä <strong>ÏòàÏÉÅ Ï†ïÎãµÎ•†:</strong> 60-70%</div>
        </div>
      </div>
    
            
            <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäº -->
            <div class="controls">
                <button class="btn" id="prevBtn" onclick="previousQuestion()" disabled>Ïù¥Ï†Ñ</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()">Îã§Ïùå</button>
                <button class="btn" id="submitBtn" onclick="submitAnswer()" style="display:none;">Ï†úÏ∂ú</button>
                <button class="btn" id="nextQuestionBtn" onclick="goToNextQuestion()" style="display:none;">Îã§Ïùå Î¨∏Ï†úÎ°ú</button>
                <button class="btn" id="finalSubmitBtn" onclick="showFinalResults()" style="display:none;">ÏµúÏ¢Ö Í≤∞Í≥º Î≥¥Í∏∞</button>
            </div>
        </div>
        
        <!-- Í≤∞Í≥º ÌôîÎ©¥ -->
        <div class="result-screen" id="resultScreen">
            <h2>ÏàòÍ≥†ÌïòÏÖ®ÏäµÎãàÎã§! üéâ</h2>
            <div class="score" id="finalScore">0/0</div>
            <div class="result-message" id="resultMessage"></div>
            <button class="btn" onclick="restartQuiz()">Îã§Ïãú ÏãúÏûë</button>
        </div>
    </div>

    <script>
        /**
         * ÌïôÏäµ Î°úÍ∑∏ Í∏∞Î°ù ÌÜµÌï© Î™®Îìà
         * Î™®Îì† ÌïôÏäµ ÌÖúÌîåÎ¶øÏóêÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÎäî Î≤îÏö© Î°úÍ∑∏ ÏãúÏä§ÌÖú
         */
        class LearningLogger {
            constructor(options = {}) {
                this.sheetId = options.sheetId || this.extractSheetId(options.sheetUrl);
                this.webAppUrl = options.webAppUrl || 'https://script.google.com/macros/s/AKfycbx7zlKeokSY6WQdFVNRQuQIjzfNy6GXeUqWRv3k2VkvFp-GgS08PR1-ScbFv_-HLpHtRw/exec';
                this.templateId = options.templateId || 'question-generation-quiz';
                this.isEnabled = options.isEnabled !== false; // Í∏∞Î≥∏Í∞í true
                this.offlineStorageKey = `learning_logs_${this.templateId}`;

                // ÏÑ∏ÏÖò Ï†ïÎ≥¥
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };

                // Ïò§ÌîÑÎùºÏù∏ Í∞êÏßÄ
                this.isOnline = navigator.onLine;
                this.setupConnectionMonitoring();

                // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Î°úÍ∑∏ Ï†ÄÏû•
                this.setupAutoSave();
            }

            /**
             * Íµ¨Í∏Ä ÏãúÌä∏ URLÏóêÏÑú ÏãúÌä∏ ID Ï∂îÏ∂ú
             */
            extractSheetId(url) {
                if (!url) return null;
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            }

            /**
             * ÌïôÏäµ ÏÑ∏ÏÖò ÏãúÏûë
             */
            startSession(studentName, additionalData = {}) {
                this.sessionData.studentName = studentName;
                this.sessionData.sessionStartTime = new Date();
                this.sessionData.additionalData = { ...additionalData };

                console.log(`üìö ÌïôÏäµ ÏÑ∏ÏÖò ÏãúÏûë: ${studentName} (${this.templateId})`);
            }

            /**
             * Ï†ïÎãµ Í∏∞Î°ù
             */
            recordCorrectAnswer() {
                this.sessionData.correctAnswers++;
            }

            /**
             * Ïò§Îãµ Í∏∞Î°ù
             */
            recordWrongAnswer() {
                this.sessionData.wrongAnswers++;
            }

            /**
             * Ïä§ÌÇµ Í∏∞Î°ù
             */
            recordSkippedAnswer() {
                this.sessionData.skippedAnswers++;
            }

            /**
             * ÌûåÌä∏ ÏÇ¨Ïö© Í∏∞Î°ù
             */
            recordHintUsed() {
                this.sessionData.hintsUsed = true;
            }

            /**
             * Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï
             */
            setAdditionalData(key, value) {
                this.sessionData.additionalData[key] = value;
            }

            /**
             * ÌïôÏäµ ÏãúÍ∞Ñ Í≥ÑÏÇ∞
             */
            calculateLearningTime() {
                if (!this.sessionData.sessionStartTime) return 0;
                const endTime = new Date();
                return Math.round((endTime - this.sessionData.sessionStartTime) / 1000); // Ï¥à Îã®ÏúÑ
            }

            /**
             * Ï†ïÏò§Îãµ Ï†ïÎ≥¥ ÏÉùÏÑ±
             */
            generateAnswerInfo() {
                const { correctAnswers, wrongAnswers, skippedAnswers } = this.sessionData;
                return `Ï†ïÎãµ:${correctAnswers}, Ïò§Îãµ:${wrongAnswers}, Ïä§ÌÇµ:${skippedAnswers}`;
            }

            /**
             * ÌïôÏäµ ÏÑ∏ÏÖò Ï¢ÖÎ£å Î∞è Î°úÍ∑∏ Ï†ÄÏû•
             */
            async endSession(additionalSessionData = {}) {
                if (!this.isEnabled) {
                    console.log('üìù Î°úÍ∑∏ Í∏∞Î°ùÏù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÏäµÎãàÎã§.');
                    return { success: true, message: 'Î°úÍ∑∏ Í∏∞Î°ù ÎπÑÌôúÏÑ±Ìôî' };
                }

                if (!this.sessionData.studentName || !this.sessionData.sessionStartTime) {
                    console.warn('‚ö†Ô∏è ÏÑ∏ÏÖòÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    return { success: false, error: 'ÏÑ∏ÏÖòÏù¥ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.' };
                }

                // ÏµúÏ¢Ö Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                this.sessionData.totalLearningTime = this.calculateLearningTime();
                this.sessionData.logTime = new Date();
                this.sessionData.additionalData = {
                    ...this.sessionData.additionalData,
                    ...additionalSessionData
                };

                const logData = this.formatLogData();

                try {
                    if (this.isOnline) {
                        // Ïò®ÎùºÏù∏ ÏÉÅÌÉú: Ï¶âÏãú Ï†ÑÏÜ°
                        const result = await this.sendToGoogleSheet(logData);

                        // ÏÑ±Í≥µ Ïãú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ÎèÑ Ï†ÑÏÜ° ÏãúÎèÑ
                        if (result.success) {
                            await this.sendOfflineLogs();
                        }

                        return result;
                    } else {
                        // Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉú: Î°úÏª¨ Ï†ÄÏû•
                        this.saveOfflineLog(logData);
                        return {
                            success: true,
                            message: 'Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÏûÖÎãàÎã§. Î°úÍ∑∏Í∞Ä ÏûÑÏãú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.',
                            isOffline: true
                        };
                    }
                } catch (error) {
                    console.error('‚ùå Î°úÍ∑∏ Ï†ÄÏû• Ïã§Ìå®:', error);
                    this.saveOfflineLog(logData);
                    return {
                        success: false,
                        error: error.message,
                        isOffline: true
                    };
                }
            }

            /**
             * Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ìè¨Îß∑ÌåÖ (Ïä§ÌîÑÎ†àÎìúÏãúÌä∏ Ïª¨Îüº Íµ¨Ï°∞Ïóê ÎßûÏ∂§)
             */
            formatLogData() {
                const totalSeconds = this.sessionData.totalLearningTime;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const formattedTime = `${minutes}Î∂Ñ ${seconds}Ï¥à`;

                return {
                    Í∏∞Îä•Î™Ö: this.templateId,
                    ÌïôÏÉùÏù¥Î¶Ñ: this.sessionData.studentName,
                    Ï†ëÏÜçÏãúÍ∞Ñ: this.sessionData.sessionStartTime.toLocaleString('ko-KR'),
                    ÌïôÏäµÏãúÍ∞Ñ: formattedTime,
                    Ï†ïÏò§ÎãµÏ†ïÎ≥¥: this.generateAnswerInfo(),
                    ÌûåÌä∏ÏÇ¨Ïö©Ïó¨Î∂Ä: this.sessionData.hintsUsed,
                    Î∂ÄÍ∞ÄÏ†ïÎ≥¥: JSON.stringify(this.sessionData.additionalData),
                    Í∏∞Î°ùÏãúÍ∞Ñ: this.sessionData.logTime.toLocaleString('ko-KR')
                };
            }

            /**
             * Íµ¨Í∏Ä ÏãúÌä∏Î°ú Îç∞Ïù¥ÌÑ∞ Ï†ÑÏÜ°
             */
            async sendToGoogleSheet(logData) {
                try {
                    if (!this.sheetId) {
                        throw new Error('Íµ¨Í∏Ä ÏãúÌä∏ IDÍ∞Ä ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.');
                    }

                    const form = new URLSearchParams();
                    form.append('sheetId', this.sheetId);
                    form.append('menu', 'learning_log');

                    // Î°úÍ∑∏ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                    Object.entries(logData).forEach(([key, value]) => {
                        form.append(key, value);
                    });

                    console.log('üì§ Íµ¨Í∏Ä ÏãúÌä∏Î°ú Î°úÍ∑∏ Ï†ÑÏÜ°:', logData);

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: form.toString()
                    });

                    console.log('‚úÖ Î°úÍ∑∏ Ï†ÑÏÜ° ÏôÑÎ£å');
                    return { success: true, message: 'Î°úÍ∑∏Í∞Ä Íµ¨Í∏Ä ÏãúÌä∏Ïóê Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.' };

                } catch (error) {
                    console.error('‚ùå Íµ¨Í∏Ä ÏãúÌä∏ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                    throw error;
                }
            }

            /**
             * Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÄÏû•
             */
            saveOfflineLog(logData) {
                try {
                    const existingLogs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');
                    existingLogs.push({
                        ...logData,
                        savedAt: new Date().toISOString(),
                        id: Date.now() + Math.random()
                    });

                    localStorage.setItem(this.offlineStorageKey, JSON.stringify(existingLogs));
                    console.log('üíæ Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÄÏû•Îê®:', logData.Í∏∞Îä•Î™Ö);
                } catch (error) {
                    console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÄÏû• Ïã§Ìå®:', error);
                }
            }

            /**
             * Ï†ÄÏû•Îêú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ°
             */
            async sendOfflineLogs() {
                try {
                    const offlineLogs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');

                    if (offlineLogs.length === 0) {
                        return { success: true, message: 'Ï†ÑÏÜ°Ìï† Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§.' };
                    }

                    console.log(`üì° ${offlineLogs.length}Í∞úÏùò Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° ÏãúÏûë`);

                    let successCount = 0;
                    for (const log of offlineLogs) {
                        try {
                            await this.sendToGoogleSheet(log);
                            successCount++;
                        } catch (error) {
                            console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° Ïã§Ìå®:', error);
                            break; // Ïã§Ìå® Ïãú Ï§ëÎã®
                        }
                    }

                    if (successCount === offlineLogs.length) {
                        // Î™®Îì† Î°úÍ∑∏ Ï†ÑÏÜ° ÏÑ±Í≥µ
                        localStorage.removeItem(this.offlineStorageKey);
                        console.log('‚úÖ Î™®Îì† Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° ÏôÑÎ£å');
                        return { success: true, message: `${successCount}Í∞úÏùò Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏Í∞Ä Ï†ÑÏÜ°ÎêòÏóàÏäµÎãàÎã§.` };
                    } else {
                        // ÏùºÎ∂ÄÎßå ÏÑ±Í≥µ
                        const remainingLogs = offlineLogs.slice(successCount);
                        localStorage.setItem(this.offlineStorageKey, JSON.stringify(remainingLogs));
                        return {
                            success: false,
                            message: `${successCount}Í∞ú Ï†ÑÏÜ°Îê®, ${remainingLogs.length}Í∞ú ÎÇ®Ïùå`
                        };
                    }

                } catch (error) {
                    console.error('‚ùå Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ° Ïò§Î•ò:', error);
                    return { success: false, error: error.message };
                }
            }

            /**
             * ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ ÏÉÅÌÉú Î™®ÎãàÌÑ∞ÎßÅ
             */
            setupConnectionMonitoring() {
                window.addEventListener('online', () => {
                    console.log('üåê Ïò®ÎùºÏù∏ ÏÉÅÌÉúÎ°ú Ï†ÑÌôò');
                    this.isOnline = true;
                    this.sendOfflineLogs(); // ÏûêÎèôÏúºÎ°ú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Ï†ÑÏÜ°
                });

                window.addEventListener('offline', () => {
                    console.log('üìµ Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÎ°ú Ï†ÑÌôò');
                    this.isOnline = false;
                });
            }

            /**
             * ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú ÏûêÎèô Ï†ÄÏû• ÏÑ§Ï†ï
             */
            setupAutoSave() {
                window.addEventListener('beforeunload', () => {
                    // ÏÑ∏ÏÖòÏù¥ ÏßÑÌñâ Ï§ëÏù¥Î©¥ ÌòÑÏû¨ ÏÉÅÌÉúÎ°ú Î°úÍ∑∏ Ï†ÄÏû•
                    if (this.sessionData.sessionStartTime && !this.sessionData.logTime) {
                        const logData = this.formatLogData();
                        logData.Î∂ÄÍ∞ÄÏ†ïÎ≥¥ = JSON.stringify({
                            ...this.sessionData.additionalData,
                            autoSaved: true,
                            reason: 'page_unload'
                        });
                        this.saveOfflineLog(logData);
                    }
                });
            }

            /**
             * Î°úÍ∑∏ Í∏∞Îä• ÌôúÏÑ±Ìôî/ÎπÑÌôúÏÑ±Ìôî
             */
            setEnabled(enabled) {
                this.isEnabled = enabled;
                console.log(`üìù Î°úÍ∑∏ Í∏∞Î°ù ${enabled ? 'ÌôúÏÑ±Ìôî' : 'ÎπÑÌôúÏÑ±Ìôî'}`);
            }

            /**
             * Ï†ÄÏû•Îêú Ïò§ÌîÑÎùºÏù∏ Î°úÍ∑∏ Í∞úÏàò ÌôïÏù∏
             */
            getOfflineLogCount() {
                try {
                    const logs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');
                    return logs.length;
                } catch {
                    return 0;
                }
            }

            /**
             * ÏÑ∏ÏÖò Ï¥àÍ∏∞Ìôî
             */
            resetSession() {
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };
            }
        }

        // ÌÄ¥Ï¶à Îç∞Ïù¥ÌÑ∞
        const questions = [{"question":"What was the name of the big, blue ball?","options":["Earth","Sun","Moon","Wind"],"correctIndex":0,"explanation":"ÏßÄÎ¨∏ÏóêÏÑú 'big, blue ball'ÏùÄ EarthÎ•º Í∞ÄÎ¶¨ÌÇµÎãàÎã§. Îã§Î•∏ ÏÑ†ÌÉùÏßÄÎì§ÏùÄ ÏßÄÎ¨∏Ïóê Ïñ∏Í∏âÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.","difficulty":"Low"},{"question":"Why did Earth feel sick?","options":["People were taking care of it.","People were cutting down trees and polluting.","The sun was too bright.","The wind was too strong."],"correctIndex":1,"explanation":"ÏßÄÎ¨∏Ïóê Îî∞Î•¥Î©¥ EarthÎäî ÏÇ¨ÎûåÎì§Ïù¥ ÎÇòÎ¨¥Î•º Î≤†Í≥† ÎçîÎü¨Ïö¥ Í≤ÉÏùÑ Í∞ïÍ≥º Î∞îÎã§Ïóê Î≤ÑÎ¶¨Îäî Îì± Ïûò ÎèåÎ≥¥ÏßÄ ÏïäÏïÑÏÑú ÏïÑÌå†ÏäµÎãàÎã§.","difficulty":"Medium"},{"question":"What did the small boy do to help Earth?","options":["Cut down trees","Pick up trash and plant trees","Turn off the sun","Make a new ball"],"correctIndex":1,"explanation":"ÏÜåÎÖÑÏùÄ Ïì∞Î†àÍ∏∞Î•º Ï§çÍ≥† ÎÇòÎ¨¥Î•º Ïã¨Ïñ¥ EarthÎ•º ÎèÑÏôîÏäµÎãàÎã§. Îã§Î•∏ ÏÑ†ÌÉùÏßÄÎäî ÏßÄÎ¨∏Ïóê ÎßûÏßÄ ÏïäÏäµÎãàÎã§.","difficulty":"High"}];
        
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let startTime = new Date();
        let questionStartTime = new Date();
        
        // ÌïôÏäµ Î°úÍ±∞ Ï¥àÍ∏∞Ìôî
        const logger = new LearningLogger({
            sheetUrl: 'https://docs.google.com/spreadsheets/d/1cdlLcI6MeTlPDUbyjoZ5KLXPQGgZ6PIfkgWiXJNYlqc/edit?usp=sharing',
            templateId: 'question-generation-quiz'
        });
        
        function initQuiz() {
            document.getElementById('totalQuestions').textContent = questions.length;
            showQuestion(0);
            
            // Î°úÍ∑∏ ÏãúÏûë
            const userName = document.getElementById('userName').value || 'ÏùµÎ™Ö';
            logger.startSession(userName, {
                activityType: 'question-generation-quiz',
                schoolLevel: 'elementary',
                grade: '3',
                totalQuestions: questions.length,
                passageId: 'question_20250820_2313_elementary_3',
                passagePreview: 'Once upon a time, there was a big, blue ball named...',
                questionsCount: questions.length
            });
        }
        
        function showQuestion(index) {
            // Î™®Îì† Î¨∏Ï†ú Ïπ¥Îìú Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // ÌòÑÏû¨ Î¨∏Ï†ú Ïπ¥Îìú Î≥¥Ïù¥Í∏∞
            const currentCard = document.getElementById(`question-${index}`);
            if (currentCard) {
                currentCard.classList.add('active');
            }
            
            // ÏßÑÌñâÏÉÅÌô© ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('currentQuestion').textContent = index + 1;
            const progress = ((index + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').style.display = index === questions.length - 1 ? 'none' : 'inline-block';
            document.getElementById('submitBtn').style.display = index === questions.length - 1 ? 'inline-block' : 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('finalSubmitBtn').style.display = 'none';
            
            // ÏÑ†ÌÉùÏßÄ Îã§Ïãú ÌôúÏÑ±Ìôî (Ïù¥Ï†Ñ Î¨∏Ï†úÎ°ú ÎèåÏïÑÍ∞à Îïå)
            const options = document.querySelectorAll(`#question-${index} .option`);
            options.forEach(option => {
                option.style.pointerEvents = 'auto';
            });
            
            questionStartTime = new Date();
        }
        
        function selectOption(questionIndex, optionIndex) {
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach((option, idx) => {
                option.classList.remove('selected');
                if (idx === optionIndex) {
                    option.classList.add('selected');
                }
            });
            
            userAnswers[questionIndex] = optionIndex;
        }
        
        function nextQuestion() {
            const userAnswer = userAnswers[currentQuestionIndex];
            if (userAnswer === undefined) {
                alert('ÎãµÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // ÌòÑÏû¨ Î¨∏Ï†ú Ï±ÑÏ†ê Î∞è Ìï¥ÏÑ§ ÌëúÏãú
            showQuestionResult(currentQuestionIndex);
        }
        
        function showQuestionResult(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = userAnswers[questionIndex];
            const isCorrect = userAnswer === question.correctIndex;
            
            console.log(`üîç Î¨∏Ï†ú ${questionIndex + 1} Ï±ÑÏ†ê:`, {
                questionIndex,
                userAnswer,
                correctIndex: question.correctIndex,
                isCorrect,
                questionData: question
            });
            
            // ÌòÑÏû¨ Î¨∏Ï†úÏùò ÏÑ†ÌÉùÏßÄÏóê Ï†ïÎãµ/Ïò§Îãµ ÌëúÏãú
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach((option, optionIndex) => {
                console.log(`ÏÑ†ÌÉùÏßÄ ${optionIndex}:`, {
                    optionIndex,
                    isCorrectAnswer: optionIndex === question.correctIndex,
                    isUserAnswer: optionIndex === userAnswer,
                    willBeMarkedCorrect: optionIndex === question.correctIndex,
                    willBeMarkedIncorrect: optionIndex === userAnswer && !isCorrect
                });
                
                if (optionIndex === question.correctIndex) {
                    option.classList.add('correct');
                } else if (optionIndex === userAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
                option.style.pointerEvents = 'none'; // ÌÅ¥Î¶≠ ÎπÑÌôúÏÑ±Ìôî
            });
            
            // Ìï¥ÏÑ§ ÌëúÏãú
            const explanation = document.querySelector(`#question-${questionIndex} .explanation`);
            if (explanation) {
                explanation.classList.add('show');
            }
            
            // Ï†ïÎãµ/Ïò§Îãµ Í∏∞Î°ù
            if (isCorrect) {
                logger.recordCorrectAnswer();
            } else {
                logger.recordWrongAnswer();
            }
            
            // Î≤ÑÌäº ÏÉÅÌÉú Î≥ÄÍ≤Ω
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            
            if (questionIndex < questions.length - 1) {
                document.getElementById('nextQuestionBtn').style.display = 'inline-block';
            } else {
                document.getElementById('finalSubmitBtn').style.display = 'inline-block';
            }
        }
        
        function goToNextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
                
                // Î≤ÑÌäº ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
                document.getElementById('nextQuestionBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }
        
        function logCurrentAnswer() {
            const question = questions[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const isCorrect = userAnswer === question.correctIndex;
            const timeTaken = (new Date() - questionStartTime) / 1000;
            
            // Ï†ïÎãµ/Ïò§Îãµ Í∏∞Î°ù
            if (isCorrect) {
                logger.recordCorrectAnswer();
            } else {
                logger.recordWrongAnswer();
            }
            
            // Ï∂îÍ∞Ä Îç∞Ïù¥ÌÑ∞ Í∏∞Î°ù
            logger.setAdditionalData(`question_${currentQuestionIndex + 1}`, {
                question: question.question,
                userAnswer: userAnswer !== undefined ? question.options[userAnswer] : 'Î¨¥ÏùëÎãµ',
                correctAnswer: question.options[question.correctIndex],
                isCorrect: isCorrect,
                timeTaken: timeTaken,
                difficulty: question.difficulty
            });
        }
        
        function submitAnswer() {
            const userAnswer = userAnswers[currentQuestionIndex];
            if (userAnswer === undefined) {
                alert('ÎãµÏùÑ ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // ÎßàÏßÄÎßâ Î¨∏Ï†ú Ï±ÑÏ†ê Î∞è Ìï¥ÏÑ§ ÌëúÏãú
            showQuestionResult(currentQuestionIndex);
        }
        
        function showFinalResults() {
            // Î™®Îì† Î¨∏Ï†ú ÏôÑÎ£å ÌõÑ ÏµúÏ¢Ö Í≤∞Í≥º ÌëúÏãú
            showResults();
        }
        
        function showResults() {
            // Î™®Îì† Î¨∏Ï†úÏóê ÎåÄÌïú Ï†ïÎãµ ÌëúÏãú
            questions.forEach((question, questionIndex) => {
                const userAnswer = userAnswers[questionIndex];
                const options = document.querySelectorAll(`#question-${questionIndex} .option`);
                
                options.forEach((option, optionIndex) => {
                    if (optionIndex === question.correctIndex) {
                        option.classList.add('correct');
                    } else if (optionIndex === userAnswer && userAnswer !== question.correctIndex) {
                        option.classList.add('incorrect');
                    }
                });
                
                // Ìï¥ÏÑ§ ÌëúÏãú
                const explanation = document.querySelector(`#question-${questionIndex} .explanation`);
                if (explanation) {
                    explanation.classList.add('show');
                }
            });
            
            // Ï†êÏàò Í≥ÑÏÇ∞
            const correctCount = userAnswers.reduce((count, answer, index) => {
                return count + (answer === questions[index].correctIndex ? 1 : 0);
            }, 0);
            
            const percentage = Math.round((correctCount / questions.length) * 100);
            
            // Í≤∞Í≥º ÌôîÎ©¥ ÌëúÏãú
            document.getElementById('finalScore').textContent = `${correctCount}/${questions.length}`;
            document.getElementById('resultMessage').textContent = `Ï†ïÎãµÎ•†: ${percentage}%`;
            
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('resultScreen').classList.add('show');
            
            // ÌïôÏäµ ÏôÑÎ£å Î°úÍ∑∏
            logger.endSession({
                totalScore: correctCount,
                maxScore: questions.length,
                percentage: percentage,
                totalTime: (new Date() - startTime) / 1000
            }).then(result => {
                if (result.success) {
                    console.log('ÌïôÏäµ Í≤∞Í≥ºÍ∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                } else {
                    console.warn('ÌïôÏäµ Í≤∞Í≥º Ï†ÄÏû• Ïã§Ìå®:', result.error);
                }
            }).catch(error => {
                console.error('ÌïôÏäµ Í≤∞Í≥º Ï†ÄÏû• Ï§ë Ïò§Î•ò:', error);
            });
        }
        
        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            startTime = new Date();
            
            // Î™®Îì† ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // Ìï¥ÏÑ§ Ïà®Í∏∞Í∏∞
            document.querySelectorAll('.explanation').forEach(explanation => {
                explanation.classList.remove('show');
            });
            
            document.querySelector('.controls').style.display = 'block';
            document.getElementById('resultScreen').classList.remove('show');
            
            showQuestion(0);
            initQuiz();
        }
        
        // Ïù¥Î¶Ñ ÏûÖÎ†• ÌõÑ Enter ÌÇ§Î°ú ÏãúÏûë
        document.getElementById('userName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                initQuiz();
            }
        });
        
        // startQuiz Ìï®Ïàò Ï∂îÍ∞Ä - ÏãúÏûë ÌôîÎ©¥ÏóêÏÑú Ïã§Ï†ú ÌÄ¥Ï¶àÎ°ú Ï†ÑÌôò
        function startQuiz() {
            const userName = document.getElementById('userName').value?.trim();
            if (!userName) {
                alert('Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // ÏãúÏûë ÌôîÎ©¥ Ïà®Í∏∞Í≥† ÌÄ¥Ï¶à ÌôîÎ©¥ ÌëúÏãú
            document.getElementById('startScreen').style.display = 'none';
            
            const quizContainer = document.querySelector('.quiz-container');
            const passageSection = document.querySelector('.passage-section');
            
            if (quizContainer) {
                quizContainer.style.display = 'block';
            }
            if (passageSection) {
                passageSection.classList.add('show');
            }
            
            // ÌÄ¥Ï¶à Ï¥àÍ∏∞Ìôî
            initQuiz();
        }
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÏãúÏûë ÌôîÎ©¥Îßå ÌëúÏãú
        window.onload = function() {
            const quizContainer = document.querySelector('.quiz-container');
            if (quizContainer) {
                quizContainer.style.display = 'none';
            }
        };
        
    </script>
</body>
</html>