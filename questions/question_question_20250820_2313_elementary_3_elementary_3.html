<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¬¸í•­ìƒì„± - elementary 3í•™ë…„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
        }
        
        .title {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
        }

        .passage-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
            display: none; /* ì²˜ìŒì—ëŠ” ìˆ¨ê¹€ */
        }
        
        .passage-section.show {
            display: block; /* í€´ì¦ˆ ì‹œì‘ ì‹œ í‘œì‹œ */
        }

        .passage-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .passage-content {
            line-height: 1.6;
            color: #555;
            font-size: 16px;
        }
        
        .name-input {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .name-input input {
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            width: 300px;
            text-align: center;
        }
        
        .question-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e1e5e9;
            display: none;
        }
        
        .question-card.active {
            display: block;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .question-number {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .difficulty-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .difficulty-low {
            background: #d4edda;
            color: #155724;
        }
        
        .difficulty-medium {
            background: #fff3cd;
            color: #856404;
        }
        
        .difficulty-high {
            background: #f8d7da;
            color: #721c24;
        }
        
        .question-text {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            line-height: 1.4;
        }
        
        .options {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .option {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .option:hover {
            border-color: #667eea;
            background: #f0f3ff;
        }
        
        .option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .option.correct {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .option.incorrect {
            border-color: #dc3545;
            background: #dc3545;
            color: white;
        }
        
        .explanation {
            background: #e7f3ff;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
            display: none;
        }
        
        .explanation.show {
            display: block;
        }
        
        .explanation-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 8px;
        }
        
        .controls {
            text-align: center;
            margin-top: 30px;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress {
            background: #e1e5e9;
            border-radius: 20px;
            height: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .progress-bar {
            background: #667eea;
            height: 100%;
            border-radius: 20px;
            transition: width 0.3s ease;
            width: 0%;
        }
        
        .stats {
            text-align: center;
            margin-bottom: 20px;
            color: #666;
        }
        
        .result-screen {
            text-align: center;
            display: none;
        }
        
        .result-screen.show {
            display: block;
        }
        
        .score {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
        }
        
        .result-message {
            font-size: 18px;
            color: #666;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">ë¬¸í•­ìƒì„± - elementary 3í•™ë…„</h1>
        
        <!-- ì§€ë¬¸ ì„¹ì…˜ -->
        <div class="passage-section">
            <div class="passage-title">ğŸ“– Reading Passage</div>
            <div class="passage-content">Once upon a time, there was a big, blue ball named Earth. Earth was always spinning around in space, and it was a home for all kinds of animals and people. 

One day, Earth began to feel sick. &quot;I feel so hot and heavy,&quot; it said. &quot;I need help.&quot; So, Earth asked the sun, &quot;Can you help me? It&#x27;s so hot here.&quot; But the sun answered, &quot;I can&#x27;t. I always give heat and light to everyone.&quot; 

Then, Earth asked the wind, &quot;Can you help me? I feel so heavy.&quot; But the wind said, &quot;I can&#x27;t. I am busy moving the air around.&quot; 

Earth was sad and didn&#x27;t know what to do. It felt hot and heavy because people were not taking good care of it. They were cutting down trees, which helps keep the air clean. They were also throwing dirty things into the rivers and oceans. This was making Earth sick.

Then, a small boy came. He was different from the others. He loved to plant trees and clean up the beach. When he saw the dirty rivers, he felt angry. &quot;Why are they doing this to our Earth?&quot; he asked. He decided to change things.

He started to pick up the trash and plant more trees. He also asked his friends to help. &quot;Let&#x27;s take care of our Earth,&quot; he said. &quot;It&#x27;s our home, and it&#x27;s the only one we have.&quot; His friends agreed, and they all worked together to clean up the Earth.

After some time, Earth started to feel better. It said, &quot;Thank you, boy. You and your friends have made me feel better. I am not as hot and heavy now.&quot; The boy smiled and promised to always take care of Earth.

This story teaches us that each one of us can make a big difference. We must remember to take care of our Earth because it is our home. Let&#x27;s not make it feel hot and heavy. Instead, let&#x27;s make it feel happy and healthy. Let&#x27;s save our Earth!</div>
        </div>
        
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="startScreen" class="name-input">
            <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" />
            <button class="btn" id="startBtn" onclick="startQuiz()">í€´ì¦ˆ ì‹œì‘</button>
        </div>
        
        <!-- í€´ì¦ˆ ì»¨í…Œì´ë„ˆ -->
        <div class="quiz-container" id="quizContainer">
            <!-- ì§„í–‰ ìƒí™© -->
            <div class="stats">
                <span id="currentQuestion">1</span> / <span id="totalQuestions">3</span>
            </div>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <!-- ë¬¸ì œ ì¹´ë“œë“¤ -->
            
      <div class="question-card" id="question-0">
        <div class="question-header">
          <span class="question-number">ë¬¸ì œ 1</span>
          <span class="difficulty-badge difficulty-low">Low</span>
        </div>
        <div class="question-text">What was the name of the big, blue ball?</div>
        <div class="options">
          <div class="option" onclick="selectOption(0, 0)">A. Earth</div><div class="option" onclick="selectOption(0, 1)">B. Sun</div><div class="option" onclick="selectOption(0, 2)">C. Moon</div><div class="option" onclick="selectOption(0, 3)">D. Wind</div>
        </div>
        <div class="explanation">
          <div class="explanation-title">ğŸ’¡ í•´ì„¤</div>
          <div>ì§€ë¬¸ì—ì„œ 'big, blue ball'ì€ Earthë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤. ë‹¤ë¥¸ ì„ íƒì§€ë“¤ì€ ì§€ë¬¸ì— ì–¸ê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br><br>ğŸ“Š <strong>ì˜ˆìƒ ì •ë‹µë¥ :</strong> 70-80%</div>
        </div>
      </div>
    
      <div class="question-card" id="question-1">
        <div class="question-header">
          <span class="question-number">ë¬¸ì œ 2</span>
          <span class="difficulty-badge difficulty-medium">Medium</span>
        </div>
        <div class="question-text">Why did Earth feel sick?</div>
        <div class="options">
          <div class="option" onclick="selectOption(1, 0)">A. People were taking care of it.</div><div class="option" onclick="selectOption(1, 1)">B. People were cutting down trees and polluting.</div><div class="option" onclick="selectOption(1, 2)">C. The sun was too bright.</div><div class="option" onclick="selectOption(1, 3)">D. The wind was too strong.</div>
        </div>
        <div class="explanation">
          <div class="explanation-title">ğŸ’¡ í•´ì„¤</div>
          <div>ì§€ë¬¸ì— ë”°ë¥´ë©´ EarthëŠ” ì‚¬ëŒë“¤ì´ ë‚˜ë¬´ë¥¼ ë² ê³  ë”ëŸ¬ìš´ ê²ƒì„ ê°•ê³¼ ë°”ë‹¤ì— ë²„ë¦¬ëŠ” ë“± ì˜ ëŒë³´ì§€ ì•Šì•„ì„œ ì•„íŒ ìŠµë‹ˆë‹¤.<br><br>ğŸ“Š <strong>ì˜ˆìƒ ì •ë‹µë¥ :</strong> 60-70%</div>
        </div>
      </div>
    
      <div class="question-card" id="question-2">
        <div class="question-header">
          <span class="question-number">ë¬¸ì œ 3</span>
          <span class="difficulty-badge difficulty-high">High</span>
        </div>
        <div class="question-text">What did the small boy do to help Earth?</div>
        <div class="options">
          <div class="option" onclick="selectOption(2, 0)">A. Cut down trees</div><div class="option" onclick="selectOption(2, 1)">B. Pick up trash and plant trees</div><div class="option" onclick="selectOption(2, 2)">C. Turn off the sun</div><div class="option" onclick="selectOption(2, 3)">D. Make a new ball</div>
        </div>
        <div class="explanation">
          <div class="explanation-title">ğŸ’¡ í•´ì„¤</div>
          <div>ì†Œë…„ì€ ì“°ë ˆê¸°ë¥¼ ì¤ê³  ë‚˜ë¬´ë¥¼ ì‹¬ì–´ Earthë¥¼ ë„ì™”ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì„ íƒì§€ëŠ” ì§€ë¬¸ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.<br><br>ğŸ“Š <strong>ì˜ˆìƒ ì •ë‹µë¥ :</strong> 60-70%</div>
        </div>
      </div>
    
            
            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
            <div class="controls">
                <button class="btn" id="prevBtn" onclick="previousQuestion()" disabled>ì´ì „</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()">ë‹¤ìŒ</button>
                <button class="btn" id="submitBtn" onclick="submitAnswer()" style="display:none;">ì œì¶œ</button>
                <button class="btn" id="nextQuestionBtn" onclick="goToNextQuestion()" style="display:none;">ë‹¤ìŒ ë¬¸ì œë¡œ</button>
                <button class="btn" id="finalSubmitBtn" onclick="showFinalResults()" style="display:none;">ìµœì¢… ê²°ê³¼ ë³´ê¸°</button>
            </div>
        </div>
        
        <!-- ê²°ê³¼ í™”ë©´ -->
        <div class="result-screen" id="resultScreen">
            <h2>ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤! ğŸ‰</h2>
            <div class="score" id="finalScore">0/0</div>
            <div class="result-message" id="resultMessage"></div>
            <button class="btn" onclick="restartQuiz()">ë‹¤ì‹œ ì‹œì‘</button>
        </div>
    </div>

    <script>
        /**
         * í•™ìŠµ ë¡œê·¸ ê¸°ë¡ í†µí•© ëª¨ë“ˆ
         * ëª¨ë“  í•™ìŠµ í…œí”Œë¦¿ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë²”ìš© ë¡œê·¸ ì‹œìŠ¤í…œ
         */
        class LearningLogger {
            constructor(options = {}) {
                this.sheetId = options.sheetId || this.extractSheetId(options.sheetUrl);
                this.webAppUrl = options.webAppUrl || 'https://script.google.com/macros/s/AKfycbx7zlKeokSY6WQdFVNRQuQIjzfNy6GXeUqWRv3k2VkvFp-GgS08PR1-ScbFv_-HLpHtRw/exec';
                this.templateId = options.templateId || 'question-generation-quiz';
                this.isEnabled = options.isEnabled !== false; // ê¸°ë³¸ê°’ true
                this.offlineStorageKey = `learning_logs_${this.templateId}`;

                // ì„¸ì…˜ ì •ë³´
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };

                // ì˜¤í”„ë¼ì¸ ê°ì§€
                this.isOnline = navigator.onLine;
                this.setupConnectionMonitoring();

                // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë¡œê·¸ ì €ì¥
                this.setupAutoSave();
            }

            /**
             * êµ¬ê¸€ ì‹œíŠ¸ URLì—ì„œ ì‹œíŠ¸ ID ì¶”ì¶œ
             */
            extractSheetId(url) {
                if (!url) return null;
                const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
                return match ? match[1] : null;
            }

            /**
             * í•™ìŠµ ì„¸ì…˜ ì‹œì‘
             */
            startSession(studentName, additionalData = {}) {
                this.sessionData.studentName = studentName;
                this.sessionData.sessionStartTime = new Date();
                this.sessionData.additionalData = { ...additionalData };

                console.log(`ğŸ“š í•™ìŠµ ì„¸ì…˜ ì‹œì‘: ${studentName} (${this.templateId})`);
            }

            /**
             * ì •ë‹µ ê¸°ë¡
             */
            recordCorrectAnswer() {
                this.sessionData.correctAnswers++;
            }

            /**
             * ì˜¤ë‹µ ê¸°ë¡
             */
            recordWrongAnswer() {
                this.sessionData.wrongAnswers++;
            }

            /**
             * ìŠ¤í‚µ ê¸°ë¡
             */
            recordSkippedAnswer() {
                this.sessionData.skippedAnswers++;
            }

            /**
             * íŒíŠ¸ ì‚¬ìš© ê¸°ë¡
             */
            recordHintUsed() {
                this.sessionData.hintsUsed = true;
            }

            /**
             * ì¶”ê°€ ë°ì´í„° ì„¤ì •
             */
            setAdditionalData(key, value) {
                this.sessionData.additionalData[key] = value;
            }

            /**
             * í•™ìŠµ ì‹œê°„ ê³„ì‚°
             */
            calculateLearningTime() {
                if (!this.sessionData.sessionStartTime) return 0;
                const endTime = new Date();
                return Math.round((endTime - this.sessionData.sessionStartTime) / 1000); // ì´ˆ ë‹¨ìœ„
            }

            /**
             * ì •ì˜¤ë‹µ ì •ë³´ ìƒì„±
             */
            generateAnswerInfo() {
                const { correctAnswers, wrongAnswers, skippedAnswers } = this.sessionData;
                return `ì •ë‹µ:${correctAnswers}, ì˜¤ë‹µ:${wrongAnswers}, ìŠ¤í‚µ:${skippedAnswers}`;
            }

            /**
             * í•™ìŠµ ì„¸ì…˜ ì¢…ë£Œ ë° ë¡œê·¸ ì €ì¥
             */
            async endSession(additionalSessionData = {}) {
                if (!this.isEnabled) {
                    console.log('ğŸ“ ë¡œê·¸ ê¸°ë¡ì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.');
                    return { success: true, message: 'ë¡œê·¸ ê¸°ë¡ ë¹„í™œì„±í™”' };
                }

                if (!this.sessionData.studentName || !this.sessionData.sessionStartTime) {
                    console.warn('âš ï¸ ì„¸ì…˜ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    return { success: false, error: 'ì„¸ì…˜ì´ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.' };
                }

                // ìµœì¢… ë°ì´í„° ì¤€ë¹„
                this.sessionData.totalLearningTime = this.calculateLearningTime();
                this.sessionData.logTime = new Date();
                this.sessionData.additionalData = {
                    ...this.sessionData.additionalData,
                    ...additionalSessionData
                };

                const logData = this.formatLogData();

                try {
                    if (this.isOnline) {
                        // ì˜¨ë¼ì¸ ìƒíƒœ: ì¦‰ì‹œ ì „ì†¡
                        const result = await this.sendToGoogleSheet(logData);

                        // ì„±ê³µ ì‹œ ì˜¤í”„ë¼ì¸ ë¡œê·¸ë„ ì „ì†¡ ì‹œë„
                        if (result.success) {
                            await this.sendOfflineLogs();
                        }

                        return result;
                    } else {
                        // ì˜¤í”„ë¼ì¸ ìƒíƒœ: ë¡œì»¬ ì €ì¥
                        this.saveOfflineLog(logData);
                        return {
                            success: true,
                            message: 'ì˜¤í”„ë¼ì¸ ìƒíƒœì…ë‹ˆë‹¤. ë¡œê·¸ê°€ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                            isOffline: true
                        };
                    }
                } catch (error) {
                    console.error('âŒ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
                    this.saveOfflineLog(logData);
                    return {
                        success: false,
                        error: error.message,
                        isOffline: true
                    };
                }
            }

            /**
             * ë¡œê·¸ ë°ì´í„° í¬ë§·íŒ… (ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ì»¬ëŸ¼ êµ¬ì¡°ì— ë§ì¶¤)
             */
            formatLogData() {
                const totalSeconds = this.sessionData.totalLearningTime;
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                const formattedTime = `${minutes}ë¶„ ${seconds}ì´ˆ`;

                return {
                    ê¸°ëŠ¥ëª…: this.templateId,
                    í•™ìƒì´ë¦„: this.sessionData.studentName,
                    ì ‘ì†ì‹œê°„: this.sessionData.sessionStartTime.toLocaleString('ko-KR'),
                    í•™ìŠµì‹œê°„: formattedTime,
                    ì •ì˜¤ë‹µì •ë³´: this.generateAnswerInfo(),
                    íŒíŠ¸ì‚¬ìš©ì—¬ë¶€: this.sessionData.hintsUsed,
                    ë¶€ê°€ì •ë³´: JSON.stringify(this.sessionData.additionalData),
                    ê¸°ë¡ì‹œê°„: this.sessionData.logTime.toLocaleString('ko-KR')
                };
            }

            /**
             * êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë°ì´í„° ì „ì†¡
             */
            async sendToGoogleSheet(logData) {
                try {
                    if (!this.sheetId) {
                        throw new Error('êµ¬ê¸€ ì‹œíŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    }

                    const form = new URLSearchParams();
                    form.append('sheetId', this.sheetId);
                    form.append('menu', 'learning_log');

                    // ë¡œê·¸ ë°ì´í„° ì¶”ê°€
                    Object.entries(logData).forEach(([key, value]) => {
                        form.append(key, value);
                    });

                    console.log('ğŸ“¤ êµ¬ê¸€ ì‹œíŠ¸ë¡œ ë¡œê·¸ ì „ì†¡:', logData);

                    const response = await fetch(this.webAppUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: form.toString()
                    });

                    console.log('âœ… ë¡œê·¸ ì „ì†¡ ì™„ë£Œ');
                    return { success: true, message: 'ë¡œê·¸ê°€ êµ¬ê¸€ ì‹œíŠ¸ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' };

                } catch (error) {
                    console.error('âŒ êµ¬ê¸€ ì‹œíŠ¸ ì „ì†¡ ì‹¤íŒ¨:', error);
                    throw error;
                }
            }

            /**
             * ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì €ì¥
             */
            saveOfflineLog(logData) {
                try {
                    const existingLogs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');
                    existingLogs.push({
                        ...logData,
                        savedAt: new Date().toISOString(),
                        id: Date.now() + Math.random()
                    });

                    localStorage.setItem(this.offlineStorageKey, JSON.stringify(existingLogs));
                    console.log('ğŸ’¾ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì €ì¥ë¨:', logData.ê¸°ëŠ¥ëª…);
                } catch (error) {
                    console.error('âŒ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }

            /**
             * ì €ì¥ëœ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì „ì†¡
             */
            async sendOfflineLogs() {
                try {
                    const offlineLogs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');

                    if (offlineLogs.length === 0) {
                        return { success: true, message: 'ì „ì†¡í•  ì˜¤í”„ë¼ì¸ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.' };
                    }

                    console.log(`ğŸ“¡ ${offlineLogs.length}ê°œì˜ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì „ì†¡ ì‹œì‘`);

                    let successCount = 0;
                    for (const log of offlineLogs) {
                        try {
                            await this.sendToGoogleSheet(log);
                            successCount++;
                        } catch (error) {
                            console.error('âŒ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì „ì†¡ ì‹¤íŒ¨:', error);
                            break; // ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
                        }
                    }

                    if (successCount === offlineLogs.length) {
                        // ëª¨ë“  ë¡œê·¸ ì „ì†¡ ì„±ê³µ
                        localStorage.removeItem(this.offlineStorageKey);
                        console.log('âœ… ëª¨ë“  ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì „ì†¡ ì™„ë£Œ');
                        return { success: true, message: `${successCount}ê°œì˜ ì˜¤í”„ë¼ì¸ ë¡œê·¸ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.` };
                    } else {
                        // ì¼ë¶€ë§Œ ì„±ê³µ
                        const remainingLogs = offlineLogs.slice(successCount);
                        localStorage.setItem(this.offlineStorageKey, JSON.stringify(remainingLogs));
                        return {
                            success: false,
                            message: `${successCount}ê°œ ì „ì†¡ë¨, ${remainingLogs.length}ê°œ ë‚¨ìŒ`
                        };
                    }

                } catch (error) {
                    console.error('âŒ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì „ì†¡ ì˜¤ë¥˜:', error);
                    return { success: false, error: error.message };
                }
            }

            /**
             * ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§
             */
            setupConnectionMonitoring() {
                window.addEventListener('online', () => {
                    console.log('ğŸŒ ì˜¨ë¼ì¸ ìƒíƒœë¡œ ì „í™˜');
                    this.isOnline = true;
                    this.sendOfflineLogs(); // ìë™ìœ¼ë¡œ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ì „ì†¡
                });

                window.addEventListener('offline', () => {
                    console.log('ğŸ“µ ì˜¤í”„ë¼ì¸ ìƒíƒœë¡œ ì „í™˜');
                    this.isOnline = false;
                });
            }

            /**
             * í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ìë™ ì €ì¥ ì„¤ì •
             */
            setupAutoSave() {
                window.addEventListener('beforeunload', () => {
                    // ì„¸ì…˜ì´ ì§„í–‰ ì¤‘ì´ë©´ í˜„ì¬ ìƒíƒœë¡œ ë¡œê·¸ ì €ì¥
                    if (this.sessionData.sessionStartTime && !this.sessionData.logTime) {
                        const logData = this.formatLogData();
                        logData.ë¶€ê°€ì •ë³´ = JSON.stringify({
                            ...this.sessionData.additionalData,
                            autoSaved: true,
                            reason: 'page_unload'
                        });
                        this.saveOfflineLog(logData);
                    }
                });
            }

            /**
             * ë¡œê·¸ ê¸°ëŠ¥ í™œì„±í™”/ë¹„í™œì„±í™”
             */
            setEnabled(enabled) {
                this.isEnabled = enabled;
                console.log(`ğŸ“ ë¡œê·¸ ê¸°ë¡ ${enabled ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”'}`);
            }

            /**
             * ì €ì¥ëœ ì˜¤í”„ë¼ì¸ ë¡œê·¸ ê°œìˆ˜ í™•ì¸
             */
            getOfflineLogCount() {
                try {
                    const logs = JSON.parse(localStorage.getItem(this.offlineStorageKey) || '[]');
                    return logs.length;
                } catch {
                    return 0;
                }
            }

            /**
             * ì„¸ì…˜ ì´ˆê¸°í™”
             */
            resetSession() {
                this.sessionData = {
                    studentName: '',
                    sessionStartTime: null,
                    totalLearningTime: 0,
                    correctAnswers: 0,
                    wrongAnswers: 0,
                    skippedAnswers: 0,
                    hintsUsed: false,
                    additionalData: {},
                    logTime: null
                };
            }
        }

        // í€´ì¦ˆ ë°ì´í„°
        const questions = [{"question":"What was the name of the big, blue ball?","options":["Earth","Sun","Moon","Wind"],"correctIndex":0,"explanation":"ì§€ë¬¸ì—ì„œ 'big, blue ball'ì€ Earthë¥¼ ê°€ë¦¬í‚µë‹ˆë‹¤. ë‹¤ë¥¸ ì„ íƒì§€ë“¤ì€ ì§€ë¬¸ì— ì–¸ê¸‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.","difficulty":"Low"},{"question":"Why did Earth feel sick?","options":["People were taking care of it.","People were cutting down trees and polluting.","The sun was too bright.","The wind was too strong."],"correctIndex":1,"explanation":"ì§€ë¬¸ì— ë”°ë¥´ë©´ EarthëŠ” ì‚¬ëŒë“¤ì´ ë‚˜ë¬´ë¥¼ ë² ê³  ë”ëŸ¬ìš´ ê²ƒì„ ê°•ê³¼ ë°”ë‹¤ì— ë²„ë¦¬ëŠ” ë“± ì˜ ëŒë³´ì§€ ì•Šì•„ì„œ ì•„íŒ ìŠµë‹ˆë‹¤.","difficulty":"Medium"},{"question":"What did the small boy do to help Earth?","options":["Cut down trees","Pick up trash and plant trees","Turn off the sun","Make a new ball"],"correctIndex":1,"explanation":"ì†Œë…„ì€ ì“°ë ˆê¸°ë¥¼ ì¤ê³  ë‚˜ë¬´ë¥¼ ì‹¬ì–´ Earthë¥¼ ë„ì™”ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì„ íƒì§€ëŠ” ì§€ë¬¸ì— ë§ì§€ ì•ŠìŠµë‹ˆë‹¤.","difficulty":"High"}];
        
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let startTime = new Date();
        let questionStartTime = new Date();
        
        // í•™ìŠµ ë¡œê±° ì´ˆê¸°í™”
        const logger = new LearningLogger({
            sheetUrl: 'https://docs.google.com/spreadsheets/d/1cdlLcI6MeTlPDUbyjoZ5KLXPQGgZ6PIfkgWiXJNYlqc/edit?usp=sharing',
            templateId: 'question-generation-quiz'
        });
        
        function initQuiz() {
            document.getElementById('totalQuestions').textContent = questions.length;
            showQuestion(0);
            
            // ë¡œê·¸ ì‹œì‘
            const userName = document.getElementById('userName').value || 'ìµëª…';
            logger.startSession(userName, {
                activityType: 'question-generation-quiz',
                schoolLevel: 'elementary',
                grade: '3',
                totalQuestions: questions.length,
                passageId: 'question_20250820_2313_elementary_3',
                passagePreview: 'Once upon a time, there was a big, blue ball named...',
                questionsCount: questions.length
            });
        }
        
        function showQuestion(index) {
            // ëª¨ë“  ë¬¸ì œ ì¹´ë“œ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.question-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // í˜„ì¬ ë¬¸ì œ ì¹´ë“œ ë³´ì´ê¸°
            const currentCard = document.getElementById(`question-${index}`);
            if (currentCard) {
                currentCard.classList.add('active');
            }
            
            // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
            document.getElementById('currentQuestion').textContent = index + 1;
            const progress = ((index + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').style.display = index === questions.length - 1 ? 'none' : 'inline-block';
            document.getElementById('submitBtn').style.display = index === questions.length - 1 ? 'inline-block' : 'none';
            document.getElementById('nextQuestionBtn').style.display = 'none';
            document.getElementById('finalSubmitBtn').style.display = 'none';
            
            // ì„ íƒì§€ ë‹¤ì‹œ í™œì„±í™” (ì´ì „ ë¬¸ì œë¡œ ëŒì•„ê°ˆ ë•Œ)
            const options = document.querySelectorAll(`#question-${index} .option`);
            options.forEach(option => {
                option.style.pointerEvents = 'auto';
            });
            
            questionStartTime = new Date();
        }
        
        function selectOption(questionIndex, optionIndex) {
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach((option, idx) => {
                option.classList.remove('selected');
                if (idx === optionIndex) {
                    option.classList.add('selected');
                }
            });
            
            userAnswers[questionIndex] = optionIndex;
        }
        
        function nextQuestion() {
            const userAnswer = userAnswers[currentQuestionIndex];
            if (userAnswer === undefined) {
                alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // í˜„ì¬ ë¬¸ì œ ì±„ì  ë° í•´ì„¤ í‘œì‹œ
            showQuestionResult(currentQuestionIndex);
        }
        
        function showQuestionResult(questionIndex) {
            const question = questions[questionIndex];
            const userAnswer = userAnswers[questionIndex];
            const isCorrect = userAnswer === question.correctIndex;
            
            console.log(`ğŸ” ë¬¸ì œ ${questionIndex + 1} ì±„ì :`, {
                questionIndex,
                userAnswer,
                correctIndex: question.correctIndex,
                isCorrect,
                questionData: question
            });
            
            // í˜„ì¬ ë¬¸ì œì˜ ì„ íƒì§€ì— ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ
            const options = document.querySelectorAll(`#question-${questionIndex} .option`);
            options.forEach((option, optionIndex) => {
                console.log(`ì„ íƒì§€ ${optionIndex}:`, {
                    optionIndex,
                    isCorrectAnswer: optionIndex === question.correctIndex,
                    isUserAnswer: optionIndex === userAnswer,
                    willBeMarkedCorrect: optionIndex === question.correctIndex,
                    willBeMarkedIncorrect: optionIndex === userAnswer && !isCorrect
                });
                
                if (optionIndex === question.correctIndex) {
                    option.classList.add('correct');
                } else if (optionIndex === userAnswer && !isCorrect) {
                    option.classList.add('incorrect');
                }
                option.style.pointerEvents = 'none'; // í´ë¦­ ë¹„í™œì„±í™”
            });
            
            // í•´ì„¤ í‘œì‹œ
            const explanation = document.querySelector(`#question-${questionIndex} .explanation`);
            if (explanation) {
                explanation.classList.add('show');
            }
            
            // ì •ë‹µ/ì˜¤ë‹µ ê¸°ë¡
            if (isCorrect) {
                logger.recordCorrectAnswer();
            } else {
                logger.recordWrongAnswer();
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            
            if (questionIndex < questions.length - 1) {
                document.getElementById('nextQuestionBtn').style.display = 'inline-block';
            } else {
                document.getElementById('finalSubmitBtn').style.display = 'inline-block';
            }
        }
        
        function goToNextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
                
                // ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
                document.getElementById('nextQuestionBtn').style.display = 'none';
                document.getElementById('nextBtn').style.display = 'inline-block';
            }
        }
        
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        }
        
        function logCurrentAnswer() {
            const question = questions[currentQuestionIndex];
            const userAnswer = userAnswers[currentQuestionIndex];
            const isCorrect = userAnswer === question.correctIndex;
            const timeTaken = (new Date() - questionStartTime) / 1000;
            
            // ì •ë‹µ/ì˜¤ë‹µ ê¸°ë¡
            if (isCorrect) {
                logger.recordCorrectAnswer();
            } else {
                logger.recordWrongAnswer();
            }
            
            // ì¶”ê°€ ë°ì´í„° ê¸°ë¡
            logger.setAdditionalData(`question_${currentQuestionIndex + 1}`, {
                question: question.question,
                userAnswer: userAnswer !== undefined ? question.options[userAnswer] : 'ë¬´ì‘ë‹µ',
                correctAnswer: question.options[question.correctIndex],
                isCorrect: isCorrect,
                timeTaken: timeTaken,
                difficulty: question.difficulty
            });
        }
        
        function submitAnswer() {
            const userAnswer = userAnswers[currentQuestionIndex];
            if (userAnswer === undefined) {
                alert('ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ë§ˆì§€ë§‰ ë¬¸ì œ ì±„ì  ë° í•´ì„¤ í‘œì‹œ
            showQuestionResult(currentQuestionIndex);
        }
        
        function showFinalResults() {
            // ëª¨ë“  ë¬¸ì œ ì™„ë£Œ í›„ ìµœì¢… ê²°ê³¼ í‘œì‹œ
            showResults();
        }
        
        function showResults() {
            // ëª¨ë“  ë¬¸ì œì— ëŒ€í•œ ì •ë‹µ í‘œì‹œ
            questions.forEach((question, questionIndex) => {
                const userAnswer = userAnswers[questionIndex];
                const options = document.querySelectorAll(`#question-${questionIndex} .option`);
                
                options.forEach((option, optionIndex) => {
                    if (optionIndex === question.correctIndex) {
                        option.classList.add('correct');
                    } else if (optionIndex === userAnswer && userAnswer !== question.correctIndex) {
                        option.classList.add('incorrect');
                    }
                });
                
                // í•´ì„¤ í‘œì‹œ
                const explanation = document.querySelector(`#question-${questionIndex} .explanation`);
                if (explanation) {
                    explanation.classList.add('show');
                }
            });
            
            // ì ìˆ˜ ê³„ì‚°
            const correctCount = userAnswers.reduce((count, answer, index) => {
                return count + (answer === questions[index].correctIndex ? 1 : 0);
            }, 0);
            
            const percentage = Math.round((correctCount / questions.length) * 100);
            
            // ê²°ê³¼ í™”ë©´ í‘œì‹œ
            document.getElementById('finalScore').textContent = `${correctCount}/${questions.length}`;
            document.getElementById('resultMessage').textContent = `ì •ë‹µë¥ : ${percentage}%`;
            
            document.querySelector('.controls').style.display = 'none';
            document.getElementById('resultScreen').classList.add('show');
            
            // í•™ìŠµ ì™„ë£Œ ë¡œê·¸
            logger.endSession({
                totalScore: correctCount,
                maxScore: questions.length,
                percentage: percentage,
                totalTime: (new Date() - startTime) / 1000
            }).then(result => {
                if (result.success) {
                    console.log('í•™ìŠµ ê²°ê³¼ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.warn('í•™ìŠµ ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', result.error);
                }
            }).catch(error => {
                console.error('í•™ìŠµ ê²°ê³¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            });
        }
        
        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            startTime = new Date();
            
            // ëª¨ë“  ì„ íƒ ì´ˆê¸°í™”
            document.querySelectorAll('.option').forEach(option => {
                option.classList.remove('selected', 'correct', 'incorrect');
            });
            
            // í•´ì„¤ ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.explanation').forEach(explanation => {
                explanation.classList.remove('show');
            });
            
            document.querySelector('.controls').style.display = 'block';
            document.getElementById('resultScreen').classList.remove('show');
            
            showQuestion(0);
            initQuiz();
        }
        
        // ì´ë¦„ ì…ë ¥ í›„ Enter í‚¤ë¡œ ì‹œì‘
        document.getElementById('userName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                initQuiz();
            }
        });
        
        // startQuiz í•¨ìˆ˜ ì¶”ê°€ - ì‹œì‘ í™”ë©´ì—ì„œ ì‹¤ì œ í€´ì¦ˆë¡œ ì „í™˜
        function startQuiz() {
            const userName = document.getElementById('userName').value?.trim();
            if (!userName) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ì‹œì‘ í™”ë©´ ìˆ¨ê¸°ê³  í€´ì¦ˆ í™”ë©´ í‘œì‹œ
            document.getElementById('startScreen').style.display = 'none';
            
            const quizContainer = document.querySelector('.quiz-container');
            const passageSection = document.querySelector('.passage-section');
            
            if (quizContainer) {
                quizContainer.style.display = 'block';
            }
            if (passageSection) {
                passageSection.classList.add('show');
            }
            
            // í€´ì¦ˆ ì´ˆê¸°í™”
            initQuiz();
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œì‘ í™”ë©´ë§Œ í‘œì‹œ
        window.onload = function() {
            const quizContainer = document.querySelector('.quiz-container');
            if (quizContainer) {
                quizContainer.style.display = 'none';
            }
        };
        
    </script>
</body>
</html>